import{b as v,n as l,f as w,P as b}from"./bootstrap.1adf5f09.js";import{n as q}from"./ns-procurement-quantity.944e2ca3.js";import k from"./ns-pos-confirm-popup.cb485ede.js";import g from"./ns-prompt-popup.14ac5ecc.js";import{_ as c}from"./lang.2d0006f0.js";import{n as P}from"./currency.ec2e3443.js";import{v as C,w as S,a as y}from"./runtime-dom.esm-bundler.febf7d20.js";import{_ as V}from"./plugin-vue_export-helper.21dcd24c.js";import{b1 as u,aB as d,aC as t,bt as f,ap as r,M as m,b6 as p,aA as j,z as T,br as U,b8 as A,aG as B}from"./runtime-core.esm-bundler.db039fbe.js";const L={name:"ns-stock-adjustment",props:["actions"],data(){return{search:"",timeout:null,suggestions:[],products:[]}},mounted(){console.log(this.actions)},methods:{__:c,nsCurrency:P,searchProduct(e){e.length>0&&v.post("/api/procurements/products/search-procurement-product",{argument:e}).subscribe(n=>{if(n.from==="products")if(n.products.length>0)n.products.length===1?this.addSuggestion(n.products[0]):this.suggestions=n.products;else return this.closeSearch(),l.error(c("Looks like no products matched the searched term.")).subscribe();else if(n.from==="procurements"){if(n.product===null)return this.closeSearch(),l.error(c("Looks like no products matched the searched term.")).subscribe();this.addProductToList(n.product)}})},addProductToList(e){if(this.products.filter(h=>h.procurement_product_id===e.id).length>0)return this.closeSearch(),l.error(c("The product already exists on the table.")).subscribe();const o=new Object;e.unit_quantity.unit=e.unit,o.quantities=[e.unit_quantity],o.name=e.name,o.adjust_unit=e.unit_quantity,o.adjust_quantity=1,o.adjust_action="",o.adjust_reason="",o.adjust_value=0,o.id=e.product_id,o.accurate_tracking=1,o.available_quantity=e.available_quantity,o.procurement_product_id=e.id,o.procurement_history=[{label:`${e.procurement.name} (${e.available_quantity})`,value:e.id}],this.products.push(o),this.closeSearch()},addSuggestion(e){w([v.get(`/api/products/${e.id}/units/quantities`)]).subscribe(n=>{if(n[0].length>0)e.quantities=n[0],e.adjust_quantity=1,e.adjust_action="",e.adjust_reason="",e.adjust_unit="",e.adjust_value=0,e.procurement_product_id=0,this.products.push(e),this.closeSearch();else return l.error(c("This product does't have any stock to adjust.")).subscribe();e.accurate_tracking})},closeSearch(){this.search="",this.suggestions=[]},recalculateProduct(e){e.adjust_unit!==""&&(["deleted","defective","lost"].includes(e.adjust_action)?e.adjust_value=-(e.adjust_quantity*e.adjust_unit.sale_price):e.adjust_value=e.adjust_quantity*e.adjust_unit.sale_price),this.$forceUpdate()},openQuantityPopup(e){e.quantity,new Promise((o,h)=>{b.show(q,{resolve:o,reject:h,quantity:e.adjust_quantity})}).then(o=>{if(!["added"].includes(e.adjust_action)){if(e.accurate_tracking!==void 0&&o.quantity>e.available_quantity)return l.error(c("The specified quantity exceed the available quantity.")).subscribe();if(o.quantity>e.adjust_unit.quantity)return l.error(c("The specified quantity exceed the available quantity.")).subscribe()}e.adjust_quantity=o.quantity,this.recalculateProduct(e)})},proceedStockAdjustment(){if(this.products.length===0)return l.error(c("Unable to proceed as the table is empty.")).subscribe();b.show(k,{title:c("Confirm Your Action"),message:c("The stock adjustment is about to be made. Would you like to confirm ?"),onAction:e=>{e&&v.post("/api/products/adjustments",{products:this.products}).subscribe(n=>{l.success(n.message).subscribe(),this.products=[]},n=>{l.error(n.message).subscribe()})}})},provideReason(e){new Promise((o,h)=>{b.show(g,{title:c("More Details"),resolve:o,reject:h,message:c("Useful to describe better what are the reasons that leaded to this adjustment."),input:e.adjust_reason,onAction:_=>{_!==!1&&(e.adjust_reason=_)}})}).then(o=>{l.success(c("The reason has been updated.")).susbcribe()}).catch(o=>{})},removeProduct(e){b.show(k,{title:c("Confirm Your Action"),message:c("Would you like to remove this product from the table ?"),onAction:n=>{if(n){const o=this.products.indexOf(e);this.products.splice(o,1)}}})}},watch:{search(){this.search.length>0?(clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.searchProduct(this.search)},500)):this.closeSearch()}}},M={class:"input-field flex border-2 input-group rounded"},N={class:"px-3 py-2 rounded-none"},Q={key:0,class:"h-0"},z={class:""},D={class:"shadow h-96 relative z-10 ns-vertical-menu zoom-in-entrance anim-duration-300 overflow-y-auto"},O=["onClick"],K={class:"ns-box rounded shadow my-2 w-full"},R={class:"table w-full ns-table"},W={class:"border-b"},Y={class:"p-2"},E={width:"120",class:"p-2 text-center"},F={width:"120",class:"p-2 text-center"},G={width:"120",class:"p-2 text-center"},H={width:"120",class:"p-2 text-center"},J={width:"120",class:"p-2 text-center"},I={width:"150",class:"p-2 text-center"},X={key:0},Z={class:"p-2 text-center",colspan:"6"},$={class:"p-2"},ee={class:"p-2"},te={class:"input-group border-2 info"},se=["onChange","onUpdate:modelValue"],ne=["value"],oe={class:"p-2"},ae={class:"input-group border-2 info"},ie=["onChange","onUpdate:modelValue"],re=["value"],ce={class:"p-2"},ue={key:0,class:"input-group border-2 info"},de=["onChange","onUpdate:modelValue"],le=["value"],_e=["onClick"],he={class:"border-b border-dashed border-blue-400 py-2 px-4"},me={class:"p-2"},pe={class:"border-b border-dashed border-blue-400 py-2 px-4"},be={class:"p-2"},fe={class:"-mx-1 flex justify-end"},ve={class:"px-1"},ye=["onClick"],je=t("i",{class:"las la-comment-dots"},null,-1),ke=[je],xe={class:"px-1"},we=["onClick"],qe=t("i",{class:"las la-times"},null,-1),ge=[qe],Pe={class:"border-t ns-box-footer p-2 flex justify-end"};function Ce(e,n,o,h,_,i){const x=A("ns-button");return u(),d("div",null,[t("div",M,[f(t("input",{onKeyup:n[0]||(n[0]=S(s=>i.closeSearch(),["esc"])),"onUpdate:modelValue":n[1]||(n[1]=s=>_.search=s),type:"text",class:"p-2 flex-auto outline-none"},null,544),[[C,_.search]]),t("button",N,r(i.__("Search")),1)]),_.suggestions.length>0?(u(),d("div",Q,[t("div",z,[t("ul",D,[(u(!0),d(m,null,p(_.suggestions,s=>(u(),d("li",{onClick:a=>i.addSuggestion(s),key:s.id,class:"cursor-pointer border-b p-2 flex justify-between"},[t("span",null,r(s.name),1)],8,O))),128))])])])):j("",!0),t("div",K,[t("table",R,[t("thead",W,[t("tr",null,[t("td",Y,r(i.__("Product")),1),t("td",E,r(i.__("Unit")),1),t("td",F,r(i.__("Operation")),1),t("td",G,r(i.__("Procurement")),1),t("td",H,r(i.__("Quantity")),1),t("td",J,r(i.__("Value")),1),t("td",I,r(i.__("Actions")),1)])]),t("tbody",null,[_.products.length===0?(u(),d("tr",X,[t("td",Z,r(i.__("Search and add some products")),1)])):j("",!0),(u(!0),d(m,null,p(_.products,s=>(u(),d("tr",{key:s.id},[t("td",$,r(s.name)+" ("+r((s.accurate_tracking===1?s.available_quantity:s.adjust_unit.quantity)||0)+")",1),t("td",ee,[t("div",te,[f(t("select",{onChange:a=>i.recalculateProduct(s),"onUpdate:modelValue":a=>s.adjust_unit=a,class:"outline-none p-2 w-full"},[(u(!0),d(m,null,p(s.quantities,a=>(u(),d("option",{key:a.id,value:a},r(a.unit.name),9,ne))),128))],40,se),[[y,s.adjust_unit]])])]),t("td",oe,[t("div",ae,[f(t("select",{onChange:a=>i.recalculateProduct(s),"onUpdate:modelValue":a=>s.adjust_action=a,name:"",id:"",class:"outline-none p-2 w-full"},[(u(!0),d(m,null,p(o.actions,a=>(u(),d("option",{key:a.value,value:a.value},r(a.label),9,re))),128))],40,ie),[[y,s.adjust_action]])])]),t("td",ce,[s.accurate_tracking===1?(u(),d("div",ue,[f(t("select",{onChange:a=>i.recalculateProduct(s),"onUpdate:modelValue":a=>s.procurement_product_id=a,name:"",id:"",class:"outline-none p-2 bg-white w-full"},[(u(!0),d(m,null,p(s.procurement_history,a=>(u(),d("option",{key:a.value,value:a.value},r(a.label),9,le))),128))],40,de),[[y,s.procurement_product_id]])])):j("",!0)]),t("td",{class:"p-2 flex items-center justify-center cursor-pointer",onClick:a=>i.openQuantityPopup(s)},[t("span",he,r(s.adjust_quantity),1)],8,_e),t("td",me,[t("span",pe,r(i.nsCurrency(s.adjust_value)),1)]),t("td",be,[t("div",fe,[t("div",ve,[t("button",{onClick:a=>i.provideReason(s),class:"ns-inset-button active info border outline-none rounded-full shadow h-10 w-10"},ke,8,ye)]),t("div",xe,[t("button",{onClick:a=>i.removeProduct(s),class:"ns-inset-button active error border outline-none rounded-full shadow h-10 w-10"},ge,8,we)])])])]))),128))])]),t("div",Pe,[T(x,{onClick:n[2]||(n[2]=s=>i.proceedStockAdjustment()),type:"info"},{default:U(()=>[B(r(i.__("Proceed")),1)]),_:1})])])])}var Qe=V(L,[["render",Ce]]);export{Qe as default};
