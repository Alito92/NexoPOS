import{_ as g}from"./ns-numpad-plus.1f0a961b.js";import{P as E}from"./product-quantity.5bc57dd3.js";import{_ as c,m as w,p as _,j as k,o as y,a as b,f as v,t as O,F as I,r as Q,e as V,q as R,P,d as x,u as h,bD as f,bE as L,g as U,y as W}from"./bootstrap.3799f74e.js";import{n as C,a as T}from"./currency.0f2c1fcb.js";import{_ as D}from"./plugin-vue_export-helper.21dcd24c.js";const F={data(){return{unitsQuantities:[],loadsUnits:!1,options:null,optionsSubscriber:null}},beforeDestroy(){this.optionsSubscriber.unsubscribe()},mounted(){this.$popup.event.subscribe(d=>{d.event==="click-overlay"&&(this.$popupParams.reject(!1),this.$popup.close())}),this.optionsSubscriber=POS.options.subscribe(d=>{this.options=d}),this.$popupParams.product.$original().selectedUnitQuantity!==void 0?this.selectUnit(this.$popupParams.product.$original().selectedUnitQuantity):this.$popupParams.product.$original().unit_quantities!==void 0&&this.$popupParams.product.$original().unit_quantities.length===1?this.selectUnit(this.$popupParams.product.$original().unit_quantities[0]):(this.loadsUnits=!0,this.loadUnits())},methods:{__:c,nsCurrency:C,displayRightPrice(d){return POS.getSalePrice(d,this.$popupParams.product.$original())},loadUnits(){w.get(`/api/nexopos/v4/products/${this.$popupParams.product.$original().id}/units/quantities`).subscribe(d=>{if(d.length===0)return this.$popup.close(),_.error(c("This product doesn't have any unit defined for selling.")).subscribe();this.unitsQuantities=d,this.unitsQuantities.length===1&&this.selectUnit(this.unitsQuantities[0])})},selectUnit(d){if(d.unit===null)return _.error(c('The unit attached to this product is missing or not assigned. Please review the "Unit" tab for this product.')).subscribe(),this.$popup.close();this.$popupParams.resolve({unit_quantity_id:d.id,unit_name:d.unit.name,$quantities:()=>d}),this.$popup.close()}}},B={class:"h-full w-full flex items-center justify-center",id:"ns-units-selector"},j={key:0,class:"ns-box w-2/3-screen lg:w-1/3-screen overflow-hidden flex flex-col"},N={id:"header",class:"h-16 flex justify-center items-center flex-shrink-0"},z={class:"font-bold text-primary"},H={key:0,class:"grid grid-flow-row grid-cols-2 overflow-y-auto"},G=["onClick"],M={class:"h-40 w-full flex items-center justify-center overflow-hidden"},K=["src","alt"],Y={key:1,class:"h-40 flex items-center justify-center"},J=v("i",{class:"las la-image text-primary text-6xl"},null,-1),X=[J],Z={class:"h-0 w-full"},ee={class:"relative w-full flex items-center justify-center -top-10 h-20 py-2 flex-col overlay"},te={class:"font-bold text-primary py-2 text-center"},se={class:"text-sm font-medium text-primary"},ie={key:1,class:"h-56 flex items-center justify-center"};function re(d,e,t,s,i,n){const r=k("ns-spinner");return y(),b("div",B,[i.unitsQuantities.length>0?(y(),b("div",j,[v("div",N,[v("h3",z,O(n.__("Choose Selling Unit")),1)]),i.unitsQuantities.length>0?(y(),b("div",H,[(y(!0),b(I,null,Q(i.unitsQuantities,a=>(y(),b("div",{onClick:u=>n.selectUnit(a),key:a.id,class:"ns-numpad-key info cursor-pointer border flex-shrink-0 flex flex-col items-center justify-center"},[v("div",M,[a.preview_url?(y(),b("img",{key:0,src:a.preview_url,class:"object-cover h-full",alt:a.unit.name},null,8,K)):V("",!0),a.preview_url?V("",!0):(y(),b("div",Y,X))]),v("div",Z,[v("div",ee,[v("h3",te,O(a.unit.name)+" ("+O(a.quantity)+")",1),v("p",se,O(n.nsCurrency(n.displayRightPrice(a))),1)])])],8,G))),128))])):V("",!0)])):V("",!0),i.unitsQuantities.length===0?(y(),b("div",ie,[R(r)])):V("",!0)])}var ne=D(F,[["render",re]]);class ae{constructor(e){this.product=e}run(){return new Promise((e,t)=>{const s=new P({popupClass:"shadow-lg h-1/2-screen w-3/4 xl:w-1/4 bg-white"}),i=this.product;s.open(ne,{resolve:e,reject:t,product:i})})}}class oe{constructor(){this.detect()}detect(){window.innerWidth<544?this.screenIs="xs":window.innerWidth>=544&&window.innerWidth<768?this.screenIs="sm":window.innerWidth>=768&&window.innerWidth<992?this.screenIs="md":window.innerWidth>=992&&window.innerWidth<1200?this.screenIs="lg":window.innerWidth>=1200&&(this.screenIs="xl")}is(e){return e===void 0?this.screenIs:this.screenIs===e}}const ue=window.nsPosDashboardButton=x(()=>g(()=>import("./ns-pos-dashboard-button.e3ba18cb.js"),["assets/ns-pos-dashboard-button.e3ba18cb.js","assets/bootstrap.3799f74e.js","assets/plugin-vue_export-helper.21dcd24c.js"])),ce=window.nsPosPendingOrderButton=x(()=>g(()=>import("./ns-pos-pending-orders-button.2242aede.js"),["assets/ns-pos-pending-orders-button.2242aede.js","assets/bootstrap.3799f74e.js","assets/ns-pos-confirm-popup.0abd3859.js","assets/plugin-vue_export-helper.21dcd24c.js","assets/currency.0f2c1fcb.js"])),le=window.nsPosOrderTypeButton=x(()=>g(()=>import("./ns-pos-order-type-button.35a281b0.js"),["assets/ns-pos-order-type-button.35a281b0.js","assets/bootstrap.3799f74e.js","assets/ns-pos-order-type-popup.0a40fc31.js","assets/plugin-vue_export-helper.21dcd24c.js"])),de=window.nsPosCustomersButton=x(()=>g(()=>import("./ns-pos-customers-button.ef63459e.js"),["assets/ns-pos-customers-button.ef63459e.js","assets/bootstrap.3799f74e.js","assets/ns-pos-customer-select-popup.31e845a4.js","assets/currency.0f2c1fcb.js","assets/plugin-vue_export-helper.21dcd24c.js","assets/ns-notice.c1143990.js","assets/ns-notice.a5114bf1.css","assets/ns-pos-confirm-popup.0abd3859.js","assets/ns-paginate.5756789f.js","assets/ns-orders-preview-popup.06b6797a.js","assets/ns-numpad-plus.1f0a961b.js","assets/ns-select-popup.da8f1f5e.js","assets/ns-prompt-popup.b15aee60.js"])),_e=window.nsPosResetButton=x(()=>g(()=>import("./ns-pos-reset-button.28750225.js"),["assets/ns-pos-reset-button.28750225.js","assets/bootstrap.3799f74e.js","assets/currency.0f2c1fcb.js","assets/plugin-vue_export-helper.21dcd24c.js","assets/ns-pos-confirm-popup.0abd3859.js","assets/ns-orders-preview-popup.06b6797a.js","assets/ns-numpad-plus.1f0a961b.js","assets/ns-select-popup.da8f1f5e.js","assets/ns-notice.c1143990.js","assets/ns-notice.a5114bf1.css","assets/ns-prompt-popup.b15aee60.js"])),pe=window.nsPosCashRegister=x(()=>g(()=>import("./ns-pos-registers-button.795f702a.js"),["assets/ns-pos-registers-button.795f702a.js","assets/bootstrap.3799f74e.js","assets/ns-pos-confirm-popup.0abd3859.js","assets/plugin-vue_export-helper.21dcd24c.js","assets/currency.0f2c1fcb.js"])),he=window.nsAlertPopup=x(()=>g(()=>import("./ns-alert-popup.421477a2.js"),["assets/ns-alert-popup.421477a2.js","assets/bootstrap.3799f74e.js","assets/plugin-vue_export-helper.21dcd24c.js"])),A=window.nsConfirmPopup=x(()=>g(()=>import("./ns-pos-confirm-popup.0abd3859.js"),["assets/ns-pos-confirm-popup.0abd3859.js","assets/bootstrap.3799f74e.js","assets/plugin-vue_export-helper.21dcd24c.js"]));window.nsPOSLoadingPopup=x(()=>g(()=>import("./ns-pos-loading-popup.22054d65.js"),["assets/ns-pos-loading-popup.22054d65.js","assets/plugin-vue_export-helper.21dcd24c.js","assets/bootstrap.3799f74e.js"]));const me=window.nsPromptPopup=x(()=>g(()=>import("./ns-prompt-popup.b15aee60.js"),["assets/ns-prompt-popup.b15aee60.js","assets/bootstrap.3799f74e.js","assets/plugin-vue_export-helper.21dcd24c.js"])),ge=window.nsLayawayPopup=x(()=>g(()=>import("./ns-pos-layaway-popup.1f869ed3.js"),["assets/ns-pos-layaway-popup.1f869ed3.js","assets/bootstrap.3799f74e.js","assets/currency.0f2c1fcb.js","assets/plugin-vue_export-helper.21dcd24c.js"])),xe=window.nsPosShippingPopup=x(()=>g(()=>import("./ns-pos-shipping-popup.c5dc9f5c.js"),["assets/ns-pos-shipping-popup.c5dc9f5c.js","assets/bootstrap.3799f74e.js","assets/plugin-vue_export-helper.21dcd24c.js"]));class S{constructor(){this._orderTypeProcessQueue=[],this._holdPopupEnabled=!0,this._initialQueue=[],this._responsive=new oe,this._isSubmitting=!1,this._processingAddQueue=!1,this.defaultOrder=()=>({discount_type:null,title:"",discount:0,register_id:this.get("register")?this.get("register").id:void 0,discount_percentage:0,subtotal:0,total:0,coupons:[],total_coupons:0,tendered:0,note:"",note_visibility:"hidden",tax_group_id:void 0,tax_type:void 0,taxes:[],tax_groups:[],payment_status:void 0,customer_id:void 0,change:0,total_products:0,shipping:0,tax_value:0,products_tax_value:0,total_tax_value:0,shipping_rate:0,shipping_type:void 0,customer:void 0,type:void 0,products:[],instalments:[],payments:[],addresses:{shipping:void 0,billing:void 0}}),this.addToCartQueue=[ae,E],this.initialize()}get screen(){return this._screen}get visibleSection(){return this._visibleSection}get paymentsType(){return this._paymentsType}get selectedPaymentType(){return this._selectedPaymentType}get order(){return this._order}get types(){return this._types}get products(){return this._products}get customers(){return this._customers}get options(){return this._options}get orderTypeQueue(){return this._orderTypeProcessQueue}get settings(){return this._settings}get breadcrumbs(){return this._breadcrumbs}get initialQueue(){return this._initialQueue}get responsive(){return this._responsive}get processingAddQueue(){return this._processingAddQueue}async reset(){this._isSubmitting=!1,this.order.next(this.defaultOrder()),this.products.next([]),this._customers.next([]),this._breadcrumbs.next([]),this.defineCurrentScreen(),this.setHoldPopupEnabled(!0),await this.processInitialQueue(),h.doAction("ns-after-cart-changed")}initialize(){this._products=new f([]),this._customers=new f([]),this._types=new f([]),this._breadcrumbs=new f([]),this._screen=new f(""),this._paymentsType=new f([]),this._visibleSection=new f("both"),this._options=new f({}),this._settings=new f({}),this._order=new f(this.defaultOrder()),this._selectedPaymentType=new f(null),this._orderTypeProcessQueue=[{identifier:"handle.delivery-order",promise:e=>new Promise((t,s)=>e&&e.identifier==="delivery"?P.show(xe,{resolve:t,reject:s}):t({status:"success",message:"Proceed"}))}],this.initialQueue.push(()=>new Promise((e,t)=>{const s=this.options.getValue(),i=this.order.getValue();return i.tax_type=s.ns_pos_tax_type,s.ns_pos_tax_group!==!1&&(i.tax_group_id=s.ns_pos_tax_group,this.order.next(i)),e({status:"success",message:"tax group assignated"})})),this.initialQueue.push(()=>new Promise((e,t)=>{const s=this.options.getValue();return this.order.getValue(),s.ns_customers_default!==!1&&w.get(`/api/nexopos/v4/customers/${s.ns_customers_default}`).subscribe({next:i=>{this.selectCustomer(i),e({status:"success",message:c("The customer has been loaded")})},error:i=>{L.error(c("An error has occured"),c("Unable to select the default customer. Looks like the customer no longer exists. Consider changing the default customer on the settings."),{actions:{readMore:{label:c("Read More"),onClick:n=>{n.close(),window.open("https://my.nexopos.com/en/documentation/troubleshooting/no-default-customer","_blank")}},close:{label:c("Close")}}}),t(i)}}),e({status:"success",message:"tax group assignated"})})),window.addEventListener("resize",()=>{this._responsive.detect(),this.defineCurrentScreen()}),window.onbeforeunload=()=>{if(this.products.getValue().length>0)return c("Some products has been added to the cart. Would youl ike to discard this order ?")},h.addAction("ns-after-cart-changed","listen-add-to-cart",()=>this.refreshCart()),this.types.subscribe(e=>{const t=Object.values(e).filter(s=>s.selected);if(t.length>0){const s=this.order.getValue();s.type=t[0],this.order.next(s)}}),window.addEventListener("resize",()=>{this._responsive.detect(),this.defineCurrentScreen()}),window.onbeforeunload=()=>{if(this.products.getValue().length>0)return c("Some products has been added to the cart. Would youl ike to discard this order ?")}}getSalePrice(e,t){return this.options.getValue().ns_pos_price_with_tax==="yes"?T(e.sale_price_with_tax):T(e.sale_price_without_tax)}getCustomPrice(e,t){return this.options.getValue().ns_pos_price_with_tax==="yes"?T(e.custom_price_with_tax):T(e.custom_price_without_tax)}getWholesalePrice(e,t){return this.options.getValue().ns_pos_price_with_tax==="yes"?T(e.wholesale_price_with_tax):T(e.wholesale_price_without_tax)}setHoldPopupEnabled(e=!0){this._holdPopupEnabled=e}getHoldPopupEnabled(){return this._holdPopupEnabled}async processInitialQueue(){for(let e in this._initialQueue)try{const t=await this._initialQueue[e]()}catch(t){_.error(t.message).subscribe()}}removeCoupon(e){const t=this.order.getValue(),s=t.coupons,i=s.indexOf(e);s.splice(i,1),t.coupons=s,this.order.next(t)}pushCoupon(e){const t=this.order.getValue();t.coupons.forEach(s=>{if(s.code===e.code){const i=c("This coupon is already added to the cart");throw _.error(i).subscribe(),i}}),t.coupons.push(e),this.order.next(t),this.refreshCart()}get header(){const e={buttons:{nsPosDashboardButton:ue,nsPosPendingOrderButton:ce,nsPosOrderTypeButton:le,nsPosCustomersButton:de,nsPosResetButton:_e}};return this.options.getValue().ns_pos_registers_enabled==="yes"&&(e.buttons.nsPosCashRegister=pe),h.doAction("ns-pos-header",e),e}defineOptions(e){this._options.next(e)}defineCurrentScreen(){this._visibleSection.next(["xs","sm"].includes(this._responsive.is())?"grid":"both"),this._screen.next(this._responsive.is())}changeVisibleSection(e){["both","cart","grid"].includes(e)&&(["cart","both"].includes(e)&&this.refreshCart(),this._visibleSection.next(e))}addPayment(e){if(e.value>0){const t=this._order.getValue();return t.payments.push(e),this._order.next(t),this.computePaid()}return _.error("Invalid amount.").subscribe()}removePayment(e){if(e.id!==void 0)return _.error(c("Unable to delete a payment attached to the order.")).subscribe();const t=this._order.getValue(),s=t.payments.indexOf(e);t.payments.splice(s,1),this._order.next(t),U.emit({identifier:"ns.pos.remove-payment",value:e}),this.updateCustomerAccount(e),this.computePaid()}updateCustomerAccount(e){if(e.identifier==="account-payment"){const t=this.order.getValue().customer;t.account_amount+=e.value,this.selectCustomer(t)}}getPriceWithoutTax(e,t,s){if(s==="inclusive")return e/(t+100)*100;if(s==="exclusive")return e}getPriceWithTax(e,t,s){if(s==="inclusive")return e;if(s==="exclusive")return e/100*(t+100)}getVatValue(e,t,s){if(s==="inclusive")return e-this.getPriceWithoutTax(e,t,s);if(s==="exclusive")return this.getPriceWithTax(e,t,s)-e}computeTaxes(){return new Promise((e,t)=>{let s=this.order.getValue();if(s=this.computeProductsTaxes(s),s.tax_group_id===void 0||s.tax_group_id===null)return this.computeOrderTaxes(s),e({data:{order:s},status:"success"});const i=s.tax_groups;if(Object.values(i).length>0)return i[s.tax_group_id]!==void 0&&(s.taxes=i[s.tax_group_id].taxes.map(n=>(n.tax_value=this.getVatValue(s.subtotal-s.discount,n.rate,s.tax_type),n))),s=this.computeOrderTaxes(s),e({status:"success",data:{tax:i[s.tax_group_id],order:s}});if(s.tax_group_id!==void 0&&s.tax_group_id.toString().length>0)w.get(`/api/nexopos/v4/taxes/groups/${s.tax_group_id}`).subscribe({next:n=>(s=this.computeOrderTaxGroup(s,n),e({status:"success",data:{tax:n,order:s}})),error:n=>t(n)});else return t({status:"failed",message:c("No tax group assigned to the order")})})}computeOrderTaxGroup(e,t){return this.options.getValue().ns_pos_vat,this.options.getValue().ns_pos_price_with_tax,t.taxes=t.taxes.map(s=>({tax_id:s.id,tax_name:s.name,rate:parseFloat(s.rate),tax_value:this.getVatValue(e.subtotal-e.discount,s.rate,e.tax_type)})),t.taxes.length===0?_.error(c("The selected tax group doesn't have any assigned sub taxes. This might cause wrong figures."),c("Proceed"),{duration:!1}).subscribe():(e.tax_groups=e.tax_groups||[],e.taxes=t.taxes,e.tax_groups[t.id]=t,this.computeOrderTaxes(e))}computeOrderTaxes(e){const t=this.options.getValue().ns_pos_vat,s=this.options.getValue().ns_pos_price_with_tax==="yes";return["flat_vat","variable_vat","products_variable_vat","products_flat_vat"].includes(t)&&e.taxes&&e.taxes.length>0&&(e.tax_value+=e.taxes.map(i=>i.tax_value).reduce((i,n)=>i+n)),e.total_tax_value=e.tax_value,["products_variable_vat","products_flat_vat","products_vat"].includes(t)&&!s&&(e.total_tax_value=e.products_tax_value+e.tax_value),e}computeProductsTaxes(e){const t=this.products.getValue(),s=t.map(n=>n.tax_value);e.products_tax_value=0;const i=this.options.getValue().ns_pos_vat;return["products_flat_vat","products_variable_vat","products_vat"].includes(i)&&s.length>0&&(e.products_tax_value+=s.reduce((n,r)=>n+r)),e.products=t,e.total_products=t.length,e}canProceedAsLaidAway(e){return new Promise(async(t,s)=>{const i=e.customer.group.minimal_credit_payment;let n=(e.total*i/100).toFixed(ns.currency.ns_currency_precision);n=parseFloat(n);try{const r=await new Promise((a,u)=>{P.show(ge,{order:e,reject:u,resolve:a})});if(r.order.instalments.length===0&&r.order.tendered<n){const a=c("Before saving this order, a minimum payment of {amount} is required").replace("{amount}",C(n));return P.show(he,{title:c("Unable to proceed"),message:a}),s({status:"failed",message:a})}else{const a=this.selectedPaymentType.getValue(),u=r.order.instalments.filter(o=>o.amount>=n&&W(o.date).isSame(ns.date.moment.startOf("day"),"day"));if(u.length===0)return t({status:"success",message:c("Layaway defined"),data:{order:r.order}});const l=u[0].amount;l>0?P.show(A,{title:c("Initial Payment"),message:c('In order to proceed, an initial payment of {amount} is required for the selected payment type "{paymentType}". Would you like to proceed ?').replace("{amount}",C(l)).replace("{paymentType}",a.label),onAction:o=>{if(o){const p={identifier:a.identifier,label:a.label,value:l,readonly:!1,selected:!0};this.addPayment(p),u[0].paid=!0,t({status:"success",message:c("Layaway defined"),data:{order:r.order}})}else s({status:"failed",message:c("The request was canceled")})}}):t({status:"success",message:c("Layaway defined"),data:{order:r.order}})}}catch(r){return s(r)}})}submitOrder(e={}){return new Promise(async(t,s)=>{var i={...this.order.getValue(),...e};const n=i.customer.group.minimal_credit_payment;if(i.payment_status!=="hold"&&i.payments.length===0&&i.total>0&&i.total>i.tendered){if(this.options.getValue().ns_orders_allow_partial==="no"){const r=c("Partially paid orders are disabled.");return s({status:"failed",message:r})}else if(n>=0)try{i=(await this.canProceedAsLaidAway(i)).data.order}catch(r){return s(r)}}if(!this._isSubmitting){const r=i.id!==void 0?"put":"post";return this._isSubmitting=!0,w[r](`/api/nexopos/v4/orders${i.id!==void 0?"/"+i.id:""}`,i).subscribe({next:a=>{t(a),this.reset(),h.doAction("ns-order-submit-successful",a),this._isSubmitting=!1;const u=this.options.getValue().ns_pos_complete_sale_audio;u.length>0&&new Audio(u).play()},error:a=>{this._isSubmitting=!1,s(a),h.doAction("ns-order-submit-failed",a)}})}return s({status:"failed",message:c("An order is currently being processed.")})})}defineQuantities(e,t=[]){return new Promise((s,i)=>{const r={unit:t.filter(u=>u.id===e.unit_id)[0]||{},sale_price_with_tax:e.mode==="normal"?parseFloat(e.price_with_tax):0,sale_price_without_tax:e.mode==="normal"?parseFloat(e.price_without_tax):0,sale_price:e.mode==="normal"?parseFloat(e.unit_price):0,sale_price_tax:e.mode==="normal"?e.tax_value:0,sale_price_edit:0,wholesale_price_with_tax:e.mode==="wholesale"?parseFloat(e.price_with_tax):0,wholesale_price_without_tax:e.mode==="wholesale"?parseFloat(e.price_without_tax):0,wholesale_price:e.mode==="wholesale"?parseFloat(e.unit_price):0,wholesale_price_tax:e.mode==="wholesale"?e.tax_value:0,wholesale_price_edit:0,custom_price_with_tax:e.mode==="custom"?parseFloat(e.price_with_tax):0,custom_price_without_tax:e.mode==="custom"?parseFloat(e.price_without_tax):0,custom_price:e.mode==="custom"?parseFloat(e.unit_price):0,custom_price_tax:e.mode==="custom"?e.tax_value:0,custom_price_edit:e.mode==="custom"?parseFloat(e.unit_price):0};let a;if(["inclusive","exclusive"].includes(e.tax_type))try{if(e.tax_group_id)w.get(`/api/nexopos/v4/taxes/groups/${e.tax_group_id}`).subscribe({next:u=>(["sale","wholesale","custom"].forEach(l=>{r[l+"_price_tax"]=u.taxes.map(o=>this.getVatValue(r[l+"_price"],o.rate,e.tax_type)).reduce((o,p)=>o+p),r["gross_"+l+"_price"]=r[l+"_price"]+r[l+"_price_tax"],r["net_"+l+"_price"]=r[l+"_price"]-r[l+"_price_tax"]}),a=u,s(r)),error:u=>{i(!1)}});else return r.sale_price_tax=0,r.wholesale_price_tax=0,r.sale_price_without_tax=e.unit_price,s(r)}catch{return _.error(c("An error has occured while computing the product.")).subscribe()}return s(r)})}loadOrder(e){return new Promise((t,s)=>{w.get(`/api/nexopos/v4/orders/${e}/pos`).subscribe({next:async i=>{try{h.doAction("ns-before-load-order",{order:i})}catch(a){return s(a)}const n=this.options.getValue();i={...this.defaultOrder(),...i};const r=[];for(let a=0;a<i.products.length;a++){const u=i.products[a];u.product===null&&(u.product={mode:"custom",name:u.name,unit_id:u.unit_id,unit_quantities:[await this.defineQuantities(u)]}),u.$original=()=>u.product,u.$quantities=()=>{let l=u.product.unit_quantities.filter(o=>+o.id==+u.unit_quantity_id||o.id===void 0)[0];return u.mode==="custom"&&n.ns_pos_price_with_tax==="yes"&&(l.custom_price_edit=u.unit_price),l},r.push(u)}i.type=Object.values(this.types.getValue()).filter(a=>a.identifier===i.type)[0],i.addresses={shipping:i.shipping_address,billing:i.billing_address},delete i.shipping_address,delete i.billing_address,this.buildOrder(i),this.buildProducts(r),await this.selectCustomer(i.customer),t(i)},error:i=>s(i)})})}buildOrder(e){this.order.next(e)}buildProducts(e){this.recomputeProducts(e),this.products.next(e),h.doAction("ns-after-cart-changed")}printOrderReceipt(e){const t=this.options.getValue();if(t.ns_pos_printing_enabled_for==="disabled")return!1;if(t.ns_pos_printing_enabled_for==="all_orders")this.printOrder(e.id);else if(t.ns_pos_printing_enabled_for==="partially_paid_orders"&&["paid","partially_paid"].includes(e.payment_status))this.printOrder(e.id);else if(t.ns_pos_printing_enabled_for==="only_paid_ordes"&&["paid"].includes(e.payment_status))this.printOrder(e.id);else return!1}printOrder(e,t=!0){const s=this.options.getValue();if(s.ns_pos_printing_enabled_for==="disabled")return!1;switch(s.ns_pos_printing_gateway){case"default":this.processRegularPrinting(e);break;default:this.processCustomPrinting(e,s.ns_pos_printing_gateway,t);break}}async processCustomPrinting(e,t,s=!0){h.applyFilters(s?"ns-order-custom-print":"ns-order-custom-print-aloud",{printed:!1,order_id:e,gateway:t}).printed===!1&&_.error(c("Unsupported print gateway.")).subscribe()}processRegularPrinting(e){const t=document.querySelector("printing-section");t&&t.remove();const s=document.createElement("iframe");s.id="printing-section",s.className="hidden",s.src=this.settings.getValue().urls.sale_printing_url.replace("{id}",e),document.body.appendChild(s)}computePaid(){const e=this._order.getValue();e.tendered=0,e.payments.length>0&&(e.tendered=e.payments.map(t=>t.value).reduce((t,s)=>s+t)),e.tendered>=e.total?e.payment_status="paid":e.tendered>0&&e.tendered<e.total&&(e.payment_status="partially_paid"),e.change=e.tendered-e.total,this._order.next(e)}setPaymentActive(e){const t=this._paymentsType.getValue(),s=t.indexOf(e);t.forEach(i=>i.selected=!1),t[s].selected=!0,this._paymentsType.next(t)}definedPaymentsType(e){this._paymentsType.next(e)}selectCustomer(e){return new Promise((t,s)=>{const i=this.order.getValue(),n=Object.assign(e.billing,{});if(delete n.id,i.customer=e,i.customer_id=e.id,i.addresses.billing=n,this.order.next(i),e.group===void 0||e.group===null)w.get(`/api/nexopos/v4/customers/${e.id}/group`).subscribe({next:r=>{i.customer.group=r,this.order.next(i),t(i)},error:r=>{s(r)}});else return t(i)})}updateCart(e,t){for(let s in t)t[s]!==void 0&&(e[s]=t[s]);this.order.next(e),this.refreshCart()}checkCart(){const e=this.order.getValue(),t=[];e.coupons.forEach(s=>{let i=!0;s.products.length>0&&(i=e.products.filter(r=>s.products.map(a=>a.product_id).includes(r.product_id)).length>0,!i&&t.indexOf(s)===-1&&t.push(s));let n=!0;s.categories.length>0&&(n=e.products.filter(r=>s.categories.map(a=>a.category_id).includes(r.$original().category_id)).length>0,!n&&t.indexOf(s)===-1&&t.push(s))}),t.forEach(s=>{_.error(c(`The coupons "%s" has been removed from the cart, as it's required conditions are no more meet.`).replace("%s",s.name),c("Okay"),{duration:6e3}).subscribe(),this.removeCoupon(s)})}async refreshCart(){this.checkCart();const e=this.products.getValue();let t=this.order.getValue(),s=this.options.getValue().ns_pos_price_with_tax;const i=e.filter(o=>o.product_type!=="dynamic").map(o=>s==="yes"?o.total_price_with_tax:o.total_price_without_tax);if(i.length>0){let o=i.reduce((m,$)=>m+$),p=0,q=e.filter(m=>m.product_type==="dynamic").map(m=>(m.unit_price=o*m.rate/100,m.total_price=m.unit_price*m.quantity,m.total_price));q.length>0&&(p=q.reduce((m,$)=>m+$)),t.subtotal=o+p}else t.subtotal=0;const n=t.coupons.map(o=>o.type==="percentage_discount"?(o.value=t.subtotal*o.discount_value/100,o.value):(o.value=o.discount_value,o.value));t.total_coupons=0,n.length>0&&(t.total_coupons=n.reduce((o,p)=>o+p)),t.discount_type==="percentage"&&(t.discount=t.discount_percentage*t.subtotal/100),t.discount>t.subtotal&&t.total_coupons===0&&(t.discount=t.subtotal,_.info(c("The discount has been set to the cart subtotal.")).subscribe()),t.tax_value=0,t.total_tax_value=0,this.order.next(t);try{t=(await this.computeTaxes()).data.order}catch(o){o!==!1&&o.message!==void 0&&_.error(o.message||c("An unexpected error has occured while fecthing taxes."),c("OKAY"),{duration:0}).subscribe()}const r=e.map(o=>o.tax_type==="inclusive"?o.tax_value:0);r.length>0&&r.reduce((o,p)=>o+p);const a=t.tax_type,u=this.options.getValue().ns_pos_vat;let l=0;["flat_vat","variable_vat","products_vat","products_flat_vat","products_variable_vat"].includes(u)&&(l=t.total_tax_value),a==="exclusive"?t.total=+(t.subtotal+(t.shipping||0)+l-t.discount-t.total_coupons).toFixed(ns.currency.ns_currency_precision):t.total=+(t.subtotal+(t.shipping||0)-t.discount-t.total_coupons).toFixed(ns.currency.ns_currency_precision),this.order.next(t),h.doAction("ns-cart-after-refreshed",t)}getStockUsage(e,t){const s=this._products.getValue().filter(i=>i.product_id===e&&i.unit_quantity_id===t).map(i=>i.quantity);return s.length>0?s.reduce((i,n)=>i+n):0}async addToCart(e){let t=new Object,s={product_id:e.id||0,name:e.name,discount_type:"percentage",discount:0,discount_percentage:0,product_type:e.product_type||"product",rate:e.rate||0,quantity:e.quantity||0,tax_group_id:e.tax_group_id,tax_type:e.tax_type||void 0,tax_value:0,unit_id:e.unit_id||0,unit_price:e.unit_price||0,price_with_tax:e.price_with_tax||0,price_without_tax:e.price_without_tax||0,unit_name:e.unit_name||"",total_price:0,total_price_without_tax:0,total_price_with_tax:0,mode:e.mode||"normal",$original:e.$original||(()=>e),$quantities:e.$quantities||void 0};if(this._processingAddQueue=!0,s.product_id!==0)for(let r in this.addToCartQueue)try{const u=await new this.addToCartQueue[r](s).run(t);t={...t,...u}}catch(a){if(a===!1)return this._processingAddQueue=!1,!1}this._processingAddQueue=!1,s={...s,...t};const i=this._products.getValue();if(this.settings.getValue().ns_pos_items_merge){const r=i.filter(a=>a.product_id===s.product_id&&a.tax_group_id===s.tax_group_id&&a.unit_id===s.unit_id&&a.unit_quantity_id===s.unit_quantity_id);r.length>0?r[0].quantity+=s.quantity:i.unshift(s)}else i.unshift(s);this.recomputeProducts(i),this.products.next(i);const n=this.options.getValue().ns_pos_new_item_audio;n.length>0&&new Audio(n).play(),h.doAction("ns-after-cart-changed")}defineTypes(e){this._types.next(e)}removeProduct(e){const t=this._products.getValue(),s=t.indexOf(e);t.splice(s,1),this.products.next(t),h.doAction("ns-after-cart-changed")}updateProduct(e,t,s=null){const i=this._products.getValue();s=s===null?i.indexOf(e):s,i[s]={...e,...t},this.recomputeProducts(i),this.products.next(i),h.doAction("ns-after-cart-changed")}recomputeProducts(e=null){e.forEach(t=>{this.computeProduct(t)})}getProductUnitPrice(e,t){switch(e){case"custom":return t.custom_price_edit;case"normal":return t.sale_price_edit;case"wholesale":return t.wholesale_price_edit}}computeProductTax(e){switch(e.mode){case"custom":return this.computeCustomProductTax(e);case"normal":return this.computeNormalProductTax(e);case"wholesale":return this.computeWholesaleProductTax(e);default:return e}}proceedProductTaxComputation(e,t){const s=e.$original(),i=s.tax_group;let n=this.getProductUnitPrice(e.mode,e.$quantities()),r=0,a=this.getProductUnitPrice(e.mode,e.$quantities());if(i!=null&&i.taxes!==void 0){let u=0;switch(i.taxes.length>0&&(u=i.taxes.map(o=>o.rate).reduce((o,p)=>o+p)),s.tax_type){case"inclusive":n=this.getPriceWithoutTax(t,u,s.tax_type),a=t;break;case"exclusive":n=t,a=this.getPriceWithTax(t,u,s.tax_type);break}const l=i.taxes.map(o=>this.getVatValue(t,o.rate,s.tax_type));l.length>0&&(r=l.reduce((o,p)=>o+p))}return{price_without_tax:n,tax_value:r,price_with_tax:a}}computeCustomProductTax(e){e.$original();const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.custom_price_edit);return t.custom_price_without_tax=s.price_without_tax,t.custom_price_with_tax=s.price_with_tax,t.custom_price_tax=s.tax_value,e.$quantities=()=>t,e}computeNormalProductTax(e){e.$original();const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.sale_price_edit);return t.sale_price_without_tax=s.price_without_tax,t.sale_price_with_tax=s.price_with_tax,t.sale_price_tax=s.tax_value,e.$quantities=()=>t,e}computeWholesaleProductTax(e){e.$original();const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.wholesale_price_edit);return t.wholesale_price_without_tax=s.price_without_tax,t.wholesale_price_with_tax=s.price_with_tax,t.wholesale_price_tax=s.tax_value,e.$quantities=()=>t,e}getPrice(e,t,s){switch(t){case"normal":return e["sale_price_"+s];case"wholesale":return e["wholesale_price_"+s];case"custom":return e["custom_price_"+s]}}computeProduct(e){e.product_type==="product"&&(e.mode==="normal"?(e.unit_price=this.getSalePrice(e.$quantities(),e.$original()),e.tax_value=e.$quantities().sale_price_tax*e.quantity):e.mode==="wholesale"&&(e.unit_price=this.getWholesalePrice(e.$quantities(),e.$original()),e.tax_value=e.$quantities().wholesale_price_tax*e.quantity),e.mode==="custom"&&(e.unit_price=this.getCustomPrice(e.$quantities(),e.$original()),e.tax_value=e.$quantities().custom_price_tax*e.quantity));let t=0,s=0,i=this.getPrice(e.$quantities(),e.mode,"with_tax"),n=this.getPrice(e.$quantities(),e.mode,"without_tax");["flat","percentage"].includes(e.discount_type)&&e.discount_type==="percentage"&&(e.discount=e.unit_price*e.discount_percentage/100*e.quantity,t=n*e.discount_percentage/100*e.quantity,s=i*e.discount_percentage/100*e.quantity),e.price_with_tax=i,e.price_without_tax=n,e.total_price=e.unit_price*e.quantity-e.discount,e.total_price_with_tax=i*e.quantity-s,e.total_price_without_tax=n*e.quantity-t,h.doAction("ns-after-product-computed",e)}loadCustomer(e){return w.get(`/api/nexopos/v4/customers/${e}`)}defineSettings(e){this._settings.next(e)}voidOrder(e){e.id!==void 0?["hold"].includes(e.payment_status)?P.show(A,{title:c("Order Deletion"),message:c("The current order will be deleted as no payment has been made so far."),onAction:t=>{t&&w.delete(`/api/nexopos/v4/orders/${e.id}`).subscribe({next:s=>{_.success(s.message).subscribe(),this.reset()},error:s=>_.error(s.message).subscribe()})}}):P.show(me,{title:c("Void The Order"),message:c("The current order will be void. This will cancel the transaction, but the order won't be deleted. Further details about the operation will be tracked on the report. Consider providing the reason of this operation."),onAction:t=>{t!==!1&&w.post(`/api/nexopos/v4/orders/${e.id}/void`,{reason:t}).subscribe({next:s=>{_.success(s.message).subscribe(),this.reset()},error:s=>_.error(s.message).subscribe()})}}):_.error(c("Unable to void an unpaid order.")).subscribe()}async triggerOrderTypeSelection(e){for(let t=0;t<this.orderTypeQueue.length;t++)await this.orderTypeQueue[t].promise(e)}set(e,t){const s=this.settings.getValue();s[e]=t,this.settings.next(s)}unset(e){const t=this.settings.getValue();delete t[e],this.settings.next(t)}get(e){return this.settings.getValue()[e]}destroy(){this._products.unsubscribe(),this._customers.unsubscribe(),this._types.unsubscribe(),this._breadcrumbs.unsubscribe(),this._paymentsType.unsubscribe(),this._screen.unsubscribe(),this._order.unsubscribe(),this._settings.unsubscribe()}}window.POS=new S;window.POSClass=S;
