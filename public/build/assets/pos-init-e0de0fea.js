var k=Object.defineProperty;var I=(l,e,t)=>e in l?k(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var _=(l,e,t)=>(I(l,typeof e!="symbol"?e+"":e,t),t);import{_ as x}from"./preload-helper-41c905a7.js";import{P as Q}from"./product-quantity-61b7d0e0.js";import{n as y,a as p,P as T,b as g,B as w,c as L,d as R,h as U}from"./bootstrap-32fd8995.js";import{n as q,a as V}from"./currency-4e1ba4e0.js";import{_ as c}from"./lang-643e0c49.js";import{_ as W}from"./_plugin-vue_export-helper-c27b6911.js";import{r as D,o as b,c as v,a as P,t as O,F,b as B,e as $,f as j,d as f}from"./runtime-core.esm-bundler-a9e64527.js";import{P as N}from"./print-3c0412fa.js";import"./ns-numpad-01515d62.js";import"./ns-numpad-plus-3c3360f4.js";import"./runtime-dom.esm-bundler-eae6104b.js";const z={data(){return{unitsQuantities:[],loadsUnits:!1,options:null,optionsSubscriber:null}},beforeDestroy(){this.optionsSubscriber.unsubscribe()},mounted(){this.$popup.event.subscribe(l=>{l.event==="click-overlay"&&(this.$popupParams.reject(!1),this.$popup.close())}),this.optionsSubscriber=POS.options.subscribe(l=>{this.options=l}),this.$popupParams.product.$original().selectedUnitQuantity!==void 0?this.selectUnit(this.$popupParams.product.$original().selectedUnitQuantity):this.$popupParams.product.$original().unit_quantities!==void 0&&this.$popupParams.product.$original().unit_quantities.length===1?this.selectUnit(this.$popupParams.product.$original().unit_quantities[0]):(this.loadsUnits=!0,this.loadUnits())},methods:{__:c,nsCurrency:q,displayRightPrice(l){return POS.getSalePrice(l,this.$popupParams.product.$original())},loadUnits(){y.get(`/api/products/${this.$popupParams.product.$original().id}/units/quantities`).subscribe(l=>{if(l.length===0)return this.$popup.close(),p.error(c("This product doesn't have any unit defined for selling.")).subscribe();this.unitsQuantities=l,this.unitsQuantities.length===1&&this.selectUnit(this.unitsQuantities[0])})},selectUnit(l){if(l.unit===null)return p.error(c('The unit attached to this product is missing or not assigned. Please review the "Unit" tab for this product.')).subscribe(),this.$popup.close();this.$popupParams.resolve({unit_quantity_id:l.id,unit_name:l.unit.name,$quantities:()=>l}),this.$popup.close()}}},H={class:"h-full w-full flex items-center justify-center",id:"ns-units-selector"},G={key:0,class:"ns-box w-2/3-screen lg:w-1/3-screen overflow-hidden flex flex-col"},M={id:"header",class:"h-16 flex justify-center items-center flex-shrink-0"},K={class:"font-bold text-primary"},Y={key:0,class:"grid grid-flow-row grid-cols-2 overflow-y-auto"},J=["onClick"],X={class:"h-40 w-full flex items-center justify-center overflow-hidden"},Z=["src","alt"],ee={key:1,class:"h-40 flex items-center justify-center"},te=P("i",{class:"las la-image text-primary text-6xl"},null,-1),se=[te],ie={class:"h-0 w-full"},re={class:"relative w-full flex items-center justify-center -top-10 h-20 py-2 flex-col overlay"},ne={class:"font-bold text-primary py-2 text-center"},ae={class:"text-sm font-medium text-primary"},oe={key:1,class:"h-56 flex items-center justify-center"};function ue(l,e,t,s,i,a){const r=D("ns-spinner");return b(),v("div",H,[i.unitsQuantities.length>0?(b(),v("div",G,[P("div",M,[P("h3",K,O(a.__("Choose Selling Unit")),1)]),i.unitsQuantities.length>0?(b(),v("div",Y,[(b(!0),v(F,null,B(i.unitsQuantities,n=>(b(),v("div",{onClick:u=>a.selectUnit(n),key:n.id,class:"ns-numpad-key info cursor-pointer border flex-shrink-0 flex flex-col items-center justify-center"},[P("div",X,[n.preview_url?(b(),v("img",{key:0,src:n.preview_url,class:"object-cover h-full",alt:n.unit.name},null,8,Z)):$("",!0),n.preview_url?$("",!0):(b(),v("div",ee,se))]),P("div",ie,[P("div",re,[P("h3",ne,O(n.unit.name)+" ("+O(n.quantity)+")",1),P("p",ae,O(a.nsCurrency(a.displayRightPrice(n))),1)])])],8,J))),128))])):$("",!0)])):$("",!0),i.unitsQuantities.length===0?(b(),v("div",oe,[j(r)])):$("",!0)])}const ce=W(z,[["render",ue]]);class le{constructor(e){this.product=e}run(){return new Promise((e,t)=>{const s=new T({popupClass:"shadow-lg h-1/2-screen w-3/4 xl:w-1/4 bg-white"}),i=this.product;s.open(ce,{resolve:e,reject:t,product:i})})}}class _e{constructor(){_(this,"screenIs");this.detect()}detect(){window.innerWidth<544?this.screenIs="xs":window.innerWidth>=544&&window.innerWidth<768?this.screenIs="sm":window.innerWidth>=768&&window.innerWidth<992?this.screenIs="md":window.innerWidth>=992&&window.innerWidth<1200?this.screenIs="lg":window.innerWidth>=1200&&(this.screenIs="xl")}is(e){return e===void 0?this.screenIs:this.screenIs===e}}const de=window.nsPosDashboardButton=f(()=>x(()=>import("./ns-pos-dashboard-button-fd5e7c0f.js"),["./ns-pos-dashboard-button-fd5e7c0f.js","./lang-643e0c49.js","./_plugin-vue_export-helper-c27b6911.js","./runtime-core.esm-bundler-a9e64527.js"],import.meta.url)),pe=window.nsPosPendingOrderButton=f(()=>x(()=>import("./ns-pos-pending-orders-button-ab1b1e22.js"),["./ns-pos-pending-orders-button-ab1b1e22.js","./bootstrap-32fd8995.js","./lang-643e0c49.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./ns-pos-confirm-popup-16fa8fc0.js","./_plugin-vue_export-helper-c27b6911.js","./currency-4e1ba4e0.js"],import.meta.url)),he=window.nsPosOrderTypeButton=f(()=>x(()=>import("./ns-pos-order-type-button-b3374144.js"),["./ns-pos-order-type-button-b3374144.js","./bootstrap-32fd8995.js","./lang-643e0c49.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./ns-pos-order-type-popup-1f3a0034.js","./_plugin-vue_export-helper-c27b6911.js"],import.meta.url)),me=window.nsPosCustomersButton=f(()=>x(()=>import("./ns-pos-customers-button-b6ab5a34.js"),["./ns-pos-customers-button-b6ab5a34.js","./preload-helper-41c905a7.js","./bootstrap-32fd8995.js","./lang-643e0c49.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./_plugin-vue_export-helper-c27b6911.js"],import.meta.url)),ge=window.nsPosResetButton=f(()=>x(()=>import("./ns-pos-reset-button-00ce9b7e.js"),["./ns-pos-reset-button-00ce9b7e.js","./bootstrap-32fd8995.js","./lang-643e0c49.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./currency-4e1ba4e0.js","./_plugin-vue_export-helper-c27b6911.js","./ns-pos-confirm-popup-16fa8fc0.js","./index.es-a0f39e76.js","./vue-upload-component-37fc7a3b.js","./vue.runtime.esm-bundler-1bae6fe8.js","./vue-upload-component-b4959dd3.css"],import.meta.url)),xe=window.nsPosCashRegister=f(()=>x(()=>import("./ns-pos-registers-button-aea91732.js"),["./ns-pos-registers-button-aea91732.js","./bootstrap-32fd8995.js","./lang-643e0c49.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./ns-pos-confirm-popup-16fa8fc0.js","./_plugin-vue_export-helper-c27b6911.js","./currency-4e1ba4e0.js"],import.meta.url)),fe=window.nsAlertPopup=f(()=>x(()=>import("./ns-alert-popup-187fdda5.js"),["./ns-alert-popup-187fdda5.js","./lang-643e0c49.js","./_plugin-vue_export-helper-c27b6911.js","./runtime-core.esm-bundler-a9e64527.js"],import.meta.url)),S=window.nsConfirmPopup=f(()=>x(()=>import("./ns-pos-confirm-popup-16fa8fc0.js"),["./ns-pos-confirm-popup-16fa8fc0.js","./lang-643e0c49.js","./bootstrap-32fd8995.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./_plugin-vue_export-helper-c27b6911.js"],import.meta.url));window.nsPOSLoadingPopup=f(()=>x(()=>import("./ns-pos-loading-popup-83ab0254.js"),["./ns-pos-loading-popup-83ab0254.js","./_plugin-vue_export-helper-c27b6911.js","./runtime-core.esm-bundler-a9e64527.js"],import.meta.url));const we=window.nsPromptPopup=f(()=>x(()=>import("./ns-prompt-popup-fd8a595f.js"),["./ns-prompt-popup-fd8a595f.js","./lang-643e0c49.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./_plugin-vue_export-helper-c27b6911.js"],import.meta.url)),ye=window.nsLayawayPopup=f(()=>x(()=>import("./ns-pos-layaway-popup-5f3b1ff9.js"),["./ns-pos-layaway-popup-5f3b1ff9.js","./bootstrap-32fd8995.js","./lang-643e0c49.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./currency-4e1ba4e0.js","./_plugin-vue_export-helper-c27b6911.js"],import.meta.url)),be=window.nsPosShippingPopup=f(()=>x(()=>import("./ns-pos-shipping-popup-300dce29.js"),["./ns-pos-shipping-popup-300dce29.js","./bootstrap-32fd8995.js","./lang-643e0c49.js","./runtime-dom.esm-bundler-eae6104b.js","./runtime-core.esm-bundler-a9e64527.js","./_plugin-vue_export-helper-c27b6911.js"],import.meta.url));let E=class{constructor(){_(this,"_products");_(this,"_breadcrumbs");_(this,"_customers");_(this,"_settings");_(this,"_types");_(this,"_orderTypeProcessQueue",[]);_(this,"_paymentsType");_(this,"_order");_(this,"_screen");_(this,"_holdPopupEnabled",!0);_(this,"_initialQueue",[]);_(this,"_options");_(this,"_responsive",new _e);_(this,"_visibleSection");_(this,"_isSubmitting",!1);_(this,"_processingAddQueue",!1);_(this,"_selectedPaymentType");_(this,"print");_(this,"defaultOrder",()=>({discount_type:null,title:"",discount:0,register_id:this.get("register")?this.get("register").id:void 0,discount_percentage:0,subtotal:0,total:0,coupons:[],total_coupons:0,tendered:0,note:"",note_visibility:"hidden",tax_group_id:void 0,tax_type:void 0,taxes:[],tax_groups:[],payment_status:void 0,customer_id:void 0,change:0,total_products:0,shipping:0,tax_value:0,products_exclusive_tax_value:0,products_inclusive_tax_value:0,total_tax_value:0,shipping_rate:0,shipping_type:void 0,customer:void 0,type:void 0,products:[],instalments:[],payments:[],addresses:{shipping:void 0,billing:void 0}}));_(this,"addToCartQueue",[le,Q]);this.initialize(),this.print=new N({urls:systemUrls,options:systemOptions})}get screen(){return this._screen}get visibleSection(){return this._visibleSection}get paymentsType(){return this._paymentsType}get selectedPaymentType(){return this._selectedPaymentType}get order(){return this._order}get types(){return this._types}get products(){return this._products}get customers(){return this._customers}get options(){return this._options}get orderTypeQueue(){return this._orderTypeProcessQueue}get settings(){return this._settings}get breadcrumbs(){return this._breadcrumbs}get initialQueue(){return this._initialQueue}get responsive(){return this._responsive}get processingAddQueue(){return this._processingAddQueue}async reset(){this._isSubmitting=!1,this.order.next(this.defaultOrder()),this.products.next([]),this._customers.next([]),this._breadcrumbs.next([]),this.defineCurrentScreen(),this.setHoldPopupEnabled(!0),await this.processInitialQueue(),g.doAction("ns-after-cart-changed")}initialize(){this._products=new w([]),this._customers=new w([]),this._types=new w([]),this._breadcrumbs=new w([]),this._screen=new w(""),this._paymentsType=new w([]),this._visibleSection=new w("both"),this._options=new w({}),this._settings=new w({}),this._order=new w(this.defaultOrder()),this._selectedPaymentType=new w(null),this._orderTypeProcessQueue=[{identifier:"handle.delivery-order",promise:e=>new Promise((t,s)=>e&&e.identifier==="delivery"?T.show(be,{resolve:t,reject:s}):t({status:"success",message:"Proceed"}))}],this.initialQueue.push(()=>new Promise((e,t)=>{const s=this.options.getValue(),i=this.order.getValue();return i.tax_type=s.ns_pos_tax_type,s.ns_pos_tax_group!==!1&&(i.tax_group_id=s.ns_pos_tax_group,this.order.next(i)),e({status:"success",message:"tax group assignated"})})),this.initialQueue.push(()=>new Promise((e,t)=>{const s=this.options.getValue();return this.order.getValue(),s.ns_customers_default!==!1&&y.get(`/api/customers/${s.ns_customers_default}`).subscribe({next:i=>{this.selectCustomer(i),e({status:"success",message:c("The customer has been loaded")})},error:i=>{L.error(c("An error has occured"),c("Unable to select the default customer. Looks like the customer no longer exists. Consider changing the default customer on the settings."),{actions:{readMore:{label:c("Read More"),onClick:a=>{a.close(),window.open("https://my.nexopos.com/en/documentation/troubleshooting/no-default-customer","_blank")}},close:{label:c("Close")}}}),t(i)}}),e({status:"success",message:"tax group assignated"})})),window.addEventListener("resize",()=>{this._responsive.detect(),this.defineCurrentScreen()}),window.onbeforeunload=()=>{if(this.products.getValue().length>0)return c("Some products has been added to the cart. Would youl ike to discard this order ?")},g.addAction("ns-after-cart-changed","listen-add-to-cart",()=>this.refreshCart()),this.types.subscribe(e=>{const t=Object.values(e).filter(s=>s.selected);if(t.length>0){const s=this.order.getValue();s.type=t[0],this.order.next(s)}}),window.addEventListener("resize",()=>{this._responsive.detect(),this.defineCurrentScreen()}),window.onbeforeunload=()=>{if(this.products.getValue().length>0)return c("Some products has been added to the cart. Would youl ike to discard this order ?")}}getSalePrice(e,t){return this.options.getValue().ns_pos_price_with_tax==="yes"?V(e.sale_price_with_tax):V(e.sale_price_without_tax)}getCustomPrice(e,t){return this.options.getValue().ns_pos_price_with_tax==="yes"?V(e.custom_price_with_tax):V(e.custom_price_without_tax)}getWholesalePrice(e,t){return this.options.getValue().ns_pos_price_with_tax==="yes"?V(e.wholesale_price_with_tax):V(e.wholesale_price_without_tax)}setHoldPopupEnabled(e=!0){this._holdPopupEnabled=e}getHoldPopupEnabled(){return this._holdPopupEnabled}async processInitialQueue(){for(let e in this._initialQueue)try{const t=await this._initialQueue[e]()}catch(t){p.error(t.message).subscribe()}}removeCoupon(e){const t=this.order.getValue(),s=t.coupons,i=s.indexOf(e);s.splice(i,1),t.coupons=s,this.order.next(t)}pushCoupon(e){const t=this.order.getValue();t.coupons.forEach(s=>{if(s.code===e.code){const i=c("This coupon is already added to the cart");throw p.error(i).subscribe(),i}}),t.coupons.push(e),this.order.next(t),this.refreshCart()}get header(){const e={buttons:{nsPosDashboardButton:de,nsPosPendingOrderButton:pe,nsPosOrderTypeButton:he,nsPosCustomersButton:me,nsPosResetButton:ge}};return this.options.getValue().ns_pos_registers_enabled==="yes"&&(e.buttons.nsPosCashRegister=xe),g.doAction("ns-pos-header",e),e}defineOptions(e){this._options.next(e)}defineCurrentScreen(){this._visibleSection.next(["xs","sm"].includes(this._responsive.is())?"grid":"both"),this._screen.next(this._responsive.is())}changeVisibleSection(e){["both","cart","grid"].includes(e)&&(["cart","both"].includes(e)&&this.refreshCart(),this._visibleSection.next(e))}addPayment(e){if(e.value>0){const t=this._order.getValue();return t.payments.push(e),this._order.next(t),this.computePaid()}return p.error("Invalid amount.").subscribe()}removePayment(e){if(e.id!==void 0)return p.error(c("Unable to delete a payment attached to the order.")).subscribe();const t=this._order.getValue(),s=t.payments.indexOf(e);t.payments.splice(s,1),this._order.next(t),R.emit({identifier:"ns.pos.remove-payment",value:e}),this.updateCustomerAccount(e),this.computePaid()}updateCustomerAccount(e){if(e.identifier==="account-payment"){const t=this.order.getValue().customer;t.account_amount+=e.value,this.selectCustomer(t)}}getPriceWithoutTax(e,t,s){if(s==="inclusive")return e/(t+100)*100;if(s==="exclusive")return e}getPriceWithTax(e,t,s){if(s==="inclusive")return e;if(s==="exclusive")return e/100*(t+100)}getVatValue(e,t,s){if(s==="inclusive")return e-this.getPriceWithoutTax(e,t,s);if(s==="exclusive")return this.getPriceWithTax(e,t,s)-e}computeTaxes(){return new Promise((e,t)=>{let s=this.order.getValue();if(s=this.computeProductsTaxes(s),s.tax_group_id===void 0||s.tax_group_id===null)return this.computeOrderTaxes(s),e({data:{order:s},status:"success"});const i=s.tax_groups;if(Object.values(i).length>0)return i[s.tax_group_id]!==void 0&&(s.taxes=i[s.tax_group_id].taxes.map(a=>(a.tax_value=this.getVatValue(s.subtotal-s.discount,a.rate,s.tax_type),a))),s=this.computeOrderTaxes(s),e({status:"success",data:{tax:i[s.tax_group_id],order:s}});if(s.tax_group_id!==void 0&&s.tax_group_id.toString().length>0)y.get(`/api/taxes/groups/${s.tax_group_id}`).subscribe({next:a=>(s=this.computeOrderTaxGroup(s,a),e({status:"success",data:{tax:a,order:s}})),error:a=>t(a)});else return t({status:"failed",message:c("No tax group assigned to the order")})})}computeOrderTaxGroup(e,t){return this.options.getValue().ns_pos_vat,this.options.getValue().ns_pos_price_with_tax,t.taxes=t.taxes.map(s=>({tax_id:s.id,tax_name:s.name,rate:parseFloat(s.rate),tax_value:this.getVatValue(e.subtotal-e.discount,s.rate,e.tax_type)})),t.taxes.length===0?p.error(c("The selected tax group doesn't have any assigned sub taxes. This might cause wrong figures."),c("Proceed"),{duration:!1}).subscribe():(e.tax_groups=e.tax_groups||[],e.taxes=t.taxes,e.tax_groups[t.id]=t,this.computeOrderTaxes(e))}computeOrderTaxes(e){const t=this.options.getValue().ns_pos_vat,s=this.options.getValue().ns_pos_price_with_tax==="yes";return["flat_vat","variable_vat","products_variable_vat","products_flat_vat"].includes(t)&&e.taxes&&e.taxes.length>0&&(e.tax_value+=e.taxes.map(i=>i.tax_value).reduce((i,a)=>i+a)),e.total_tax_value=e.tax_value,["products_variable_vat","products_flat_vat","products_vat"].includes(t)&&!s&&(e.total_tax_value=e.products_exclusive_tax_value+e.tax_value),e}computeProductsTaxes(e){const t=this.products.getValue(),s=t.filter(r=>r.tax_type==="inclusive").map(r=>r.tax_value),i=t.filter(r=>r.tax_type==="exclusive").map(r=>r.tax_value);e.products_exclusive_tax_value=0,e.products_inclusive_tax_value=0;const a=this.options.getValue().ns_pos_vat;return["products_flat_vat","products_variable_vat","products_vat"].includes(a)&&i.length>0&&(e.products_exclusive_tax_value+=i.reduce((r,n)=>r+n)),["products_flat_vat","products_variable_vat","products_vat"].includes(a)&&s.length>0&&(e.products_inclusive_tax_value+=s.reduce((r,n)=>r+n)),e.products=t,e.total_products=t.length,e}canProceedAsLaidAway(e){return new Promise(async(t,s)=>{const i=e.customer.group.minimal_credit_payment;let a=(e.total*i/100).toFixed(ns.currency.ns_currency_precision);a=parseFloat(a);try{const r=await new Promise((n,u)=>{T.show(ye,{order:e,reject:u,resolve:n})});if(r.order.instalments.length===0&&r.order.tendered<a){const n=c("Before saving this order, a minimum payment of {amount} is required").replace("{amount}",q(a));return T.show(fe,{title:c("Unable to proceed"),message:n}),s({status:"failed",message:n})}else{const n=this.selectedPaymentType.getValue(),u=r.order.instalments.filter(o=>o.amount>=a&&U(o.date).isSame(ns.date.moment.startOf("day"),"day"));if(u.length===0)return t({status:"success",message:c("Layaway defined"),data:{order:r.order}});const d=u[0].amount;d>0?T.show(S,{title:c("Initial Payment"),message:c('In order to proceed, an initial payment of {amount} is required for the selected payment type "{paymentType}". Would you like to proceed ?').replace("{amount}",q(d)).replace("{paymentType}",n.label),onAction:o=>{if(o){const h={identifier:n.identifier,label:n.label,value:d,readonly:!1,selected:!0};this.addPayment(h),u[0].paid=!0,t({status:"success",message:c("Layaway defined"),data:{order:r.order}})}else s({status:"failed",message:c("The request was canceled")})}}):t({status:"success",message:c("Layaway defined"),data:{order:r.order}})}}catch(r){return s(r)}})}submitOrder(e={}){return new Promise(async(t,s)=>{var i={...this.order.getValue(),...e};const a=i.customer.group.minimal_credit_payment;if(i.payment_status!=="hold"&&i.payments.length===0&&i.total>0&&i.total>i.tendered){if(this.options.getValue().ns_orders_allow_partial==="no"){const r=c("Partially paid orders are disabled.");return s({status:"failed",message:r})}else if(a>=0)try{i=(await this.canProceedAsLaidAway(i)).data.order}catch(r){return s(r)}}if(!this._isSubmitting){const r=i.id!==void 0?"put":"post";return this._isSubmitting=!0,y[r](`/api/orders${i.id!==void 0?"/"+i.id:""}`,i).subscribe({next:n=>{t(n),this.reset(),g.doAction("ns-order-submit-successful",n),this._isSubmitting=!1;const u=this.options.getValue().ns_pos_complete_sale_audio;u.length>0&&new Audio(u).play()},error:n=>{this._isSubmitting=!1,s(n),g.doAction("ns-order-submit-failed",n)}})}return s({status:"failed",message:c("An order is currently being processed.")})})}defineQuantities(e,t=[]){return new Promise((s,i)=>{const r={unit:t.filter(u=>u.id===e.unit_id)[0]||{},sale_price_with_tax:e.mode==="normal"?parseFloat(e.price_with_tax):0,sale_price_without_tax:e.mode==="normal"?parseFloat(e.price_without_tax):0,sale_price:e.mode==="normal"?parseFloat(e.unit_price):0,sale_price_tax:e.mode==="normal"?e.tax_value:0,sale_price_edit:0,wholesale_price_with_tax:e.mode==="wholesale"?parseFloat(e.price_with_tax):0,wholesale_price_without_tax:e.mode==="wholesale"?parseFloat(e.price_without_tax):0,wholesale_price:e.mode==="wholesale"?parseFloat(e.unit_price):0,wholesale_price_tax:e.mode==="wholesale"?e.tax_value:0,wholesale_price_edit:0,custom_price_with_tax:e.mode==="custom"?parseFloat(e.price_with_tax):0,custom_price_without_tax:e.mode==="custom"?parseFloat(e.price_without_tax):0,custom_price:e.mode==="custom"?parseFloat(e.unit_price):0,custom_price_tax:e.mode==="custom"?e.tax_value:0,custom_price_edit:e.mode==="custom"?parseFloat(e.unit_price):0};let n;if(["inclusive","exclusive"].includes(e.tax_type))try{if(e.tax_group_id)y.get(`/api/taxes/groups/${e.tax_group_id}`).subscribe({next:u=>(["sale","wholesale","custom"].forEach(d=>{r[d+"_price_tax"]=u.taxes.map(o=>this.getVatValue(r[d+"_price"],o.rate,e.tax_type)).reduce((o,h)=>o+h),r["gross_"+d+"_price"]=r[d+"_price"]+r[d+"_price_tax"],r["net_"+d+"_price"]=r[d+"_price"]-r[d+"_price_tax"]}),n=u,s(r)),error:u=>{i(!1)}});else return r.sale_price_tax=0,r.wholesale_price_tax=0,r.sale_price_without_tax=e.unit_price,s(r)}catch{return p.error(c("An error has occurred while computing the product.")).subscribe()}return s(r)})}loadOrder(e){return new Promise((t,s)=>{y.get(`/api/orders/${e}/pos`).subscribe({next:async i=>{try{g.doAction("ns-before-load-order",{order:i})}catch(n){return s(n)}const a=this.options.getValue();i={...this.defaultOrder(),...i};const r=[];for(let n=0;n<i.products.length;n++){const u=i.products[n];u.product===null&&(u.product={mode:"custom",name:u.name,unit_id:u.unit_id,unit_quantities:[await this.defineQuantities(u)]}),u.$original=()=>u.product,u.$quantities=()=>{let d=u.product.unit_quantities.filter(o=>+o.id==+u.unit_quantity_id||o.id===void 0)[0];return u.mode==="custom"&&a.ns_pos_price_with_tax==="yes"&&(d.custom_price_edit=u.unit_price),d},r.push(u)}i.type=Object.values(this.types.getValue()).filter(n=>n.identifier===i.type)[0],i.addresses={shipping:i.shipping_address,billing:i.billing_address},delete i.shipping_address,delete i.billing_address,this.buildOrder(i),this.buildProducts(r),await this.selectCustomer(i.customer),t(i)},error:i=>s(i)})})}buildOrder(e){this.order.next(e)}buildProducts(e){this.recomputeProducts(e),this.products.next(e),g.doAction("ns-after-cart-changed")}printOrderReceipt(e,t){const s=this.options.getValue();if(s.ns_pos_printing_enabled_for==="disabled")return!1;if(s.ns_pos_printing_enabled_for==="all_orders")this.print.process(e.id,"sale",t);else if(s.ns_pos_printing_enabled_for==="partially_paid_orders"&&["paid","partially_paid"].includes(e.payment_status))this.print.process(e.id,"sale",t);else if(s.ns_pos_printing_enabled_for==="only_paid_orders"&&["paid"].includes(e.payment_status))this.print.process(e.id,"sale",t);else return!1}computePaid(){const e=this._order.getValue();e.tendered=0,e.payments.length>0&&(e.tendered=e.payments.map(t=>t.value).reduce((t,s)=>s+t)),e.tendered>=e.total?e.payment_status="paid":e.tendered>0&&e.tendered<e.total&&(e.payment_status="partially_paid"),e.change=e.tendered-e.total,this._order.next(e)}setPaymentActive(e){const t=this._paymentsType.getValue(),s=t.indexOf(e);t.forEach(i=>i.selected=!1),t[s].selected=!0,this._paymentsType.next(t)}definedPaymentsType(e){this._paymentsType.next(e)}selectCustomer(e){return new Promise((t,s)=>{const i=this.order.getValue(),a=Object.assign(e.billing||{},{});if(a.id!==void 0&&delete a.id,i.customer=e,i.customer_id=e.id,i.addresses.billing=a,this.order.next(i),e.group===void 0||e.group===null)y.get(`/api/customers/${e.id}/group`).subscribe({next:r=>{i.customer.group=r,this.order.next(i),t(i)},error:r=>{s(r)}});else return t(i)})}updateCart(e,t){for(let s in t)t[s]!==void 0&&(e[s]=t[s]);this.order.next(e),this.refreshCart()}checkCart(){const e=this.order.getValue(),t=[];e.coupons.forEach(s=>{let i=!0;s.products.length>0&&(i=e.products.filter(r=>s.products.map(n=>n.product_id).includes(r.product_id)).length>0,!i&&t.indexOf(s)===-1&&t.push(s));let a=!0;s.categories.length>0&&(a=e.products.filter(r=>s.categories.map(n=>n.category_id).includes(r.$original().category_id)).length>0,!a&&t.indexOf(s)===-1&&t.push(s))}),t.forEach(s=>{p.error(c(`The coupons "%s" has been removed from the cart, as it's required conditions are no more meet.`).replace("%s",s.name),c("Okay"),{duration:6e3}).subscribe(),this.removeCoupon(s)})}async refreshCart(){this.checkCart();const e=this.products.getValue();let t=this.order.getValue(),s=this.options.getValue().ns_pos_price_with_tax;const i=e.filter(o=>o.product_type!=="dynamic").map(o=>s==="yes"?o.total_price_with_tax:o.total_price_without_tax);if(i.length>0){let o=i.reduce((m,C)=>m+C),h=0,A=e.filter(m=>m.product_type==="dynamic").map(m=>(m.unit_price=o*m.rate/100,m.total_price=m.unit_price*m.quantity,m.total_price));A.length>0&&(h=A.reduce((m,C)=>m+C)),t.subtotal=o+h}else t.subtotal=0;const a=t.coupons.map(o=>o.type==="percentage_discount"?(o.value=t.subtotal*o.discount_value/100,o.value):(o.value=o.discount_value,o.value));t.total_coupons=0,a.length>0&&(t.total_coupons=a.reduce((o,h)=>o+h)),t.discount_type==="percentage"&&(t.discount=t.discount_percentage*t.subtotal/100),t.discount>t.subtotal&&t.total_coupons===0&&(t.discount=t.subtotal,p.info(c("The discount has been set to the cart subtotal.")).subscribe()),t.tax_value=0,t.total_tax_value=0,this.order.next(t);try{t=(await this.computeTaxes()).data.order}catch(o){o!==!1&&o.message!==void 0&&p.error(o.message||c("An unexpected error has occurred while fecthing taxes."),c("OKAY"),{duration:0}).subscribe()}const r=e.map(o=>o.tax_type==="inclusive"?o.tax_value:0);r.length>0&&r.reduce((o,h)=>o+h);const n=t.tax_type,u=this.options.getValue().ns_pos_vat;let d=0;["flat_vat","variable_vat","products_vat","products_flat_vat","products_variable_vat"].includes(u)&&(d=t.total_tax_value),n==="exclusive"?t.total=+(t.subtotal+(t.shipping||0)+d-t.discount-t.total_coupons).toFixed(ns.currency.ns_currency_precision):t.total=+(t.subtotal+(t.shipping||0)-t.discount-t.total_coupons).toFixed(ns.currency.ns_currency_precision),this.order.next(t),g.doAction("ns-cart-after-refreshed",t)}getStockUsage(e,t){const s=this._products.getValue().filter(i=>i.product_id===e&&i.unit_quantity_id===t).map(i=>i.quantity);return s.length>0?s.reduce((i,a)=>i+a):0}async addToCart(e){let t=new Object,s={product_id:e.id||0,name:e.name,discount_type:"percentage",discount:0,discount_percentage:0,product_type:e.product_type||"product",rate:e.rate||0,quantity:e.quantity||0,tax_group_id:e.tax_group_id,tax_type:e.tax_type||void 0,tax_value:0,unit_id:e.unit_id||0,unit_price:e.unit_price||0,price_with_tax:e.price_with_tax||0,price_without_tax:e.price_without_tax||0,unit_name:e.unit_name||"",total_price:0,total_price_without_tax:0,total_price_with_tax:0,mode:e.mode||"normal",$original:e.$original||(()=>e),$quantities:e.$quantities||void 0};if(this._processingAddQueue=!0,s.product_id!==0)for(let r in this.addToCartQueue)try{const u=await new this.addToCartQueue[r](s).run(t);t={...t,...u}}catch(n){if(n===!1)return this._processingAddQueue=!1,!1}this._processingAddQueue=!1,s={...s,...t};const i=this._products.getValue();if(this.settings.getValue().ns_pos_items_merge){const r=i.filter(n=>n.product_id===s.product_id&&n.tax_group_id===s.tax_group_id&&n.unit_id===s.unit_id&&n.unit_quantity_id===s.unit_quantity_id);r.length>0?r[0].quantity+=s.quantity:i.unshift(s)}else i.unshift(s);this.recomputeProducts(i),this.products.next(i);const a=this.options.getValue().ns_pos_new_item_audio;a.length>0&&new Audio(a).play(),g.doAction("ns-after-cart-changed")}defineTypes(e){this._types.next(e)}removeProduct(e){const t=this._products.getValue(),s=t.indexOf(e);t.splice(s,1),this.products.next(t),g.doAction("ns-after-cart-changed")}updateProduct(e,t,s=null){const i=this._products.getValue();s=s===null?i.indexOf(e):s,s=s===-1?0:s,console.log(e,t,s),i[s]={...e,...t},this.recomputeProducts(i),this.products.next(i),g.doAction("ns-after-cart-changed")}recomputeProducts(e=null){e.forEach(t=>{this.computeProduct(t)})}getProductUnitPrice(e,t){switch(e){case"custom":return t.custom_price_edit;case"normal":return t.sale_price_edit;case"wholesale":return t.wholesale_price_edit}}computeProductTax(e){switch(e.mode){case"custom":return this.computeCustomProductTax(e);case"normal":return this.computeNormalProductTax(e);case"wholesale":return this.computeWholesaleProductTax(e);default:return e}}proceedProductTaxComputation(e,t){const s=e.$original(),i=s.tax_group;let a=this.getProductUnitPrice(e.mode,e.$quantities()),r=0,n=this.getProductUnitPrice(e.mode,e.$quantities());if(i!=null&&i.taxes!==void 0){let u=0;switch(i.taxes.length>0&&(u=i.taxes.map(o=>o.rate).reduce((o,h)=>o+h)),s.tax_type){case"inclusive":a=this.getPriceWithoutTax(t,u,s.tax_type),n=t;break;case"exclusive":a=t,n=this.getPriceWithTax(t,u,s.tax_type);break}const d=i.taxes.map(o=>this.getVatValue(t,o.rate,s.tax_type));d.length>0&&(r=d.reduce((o,h)=>o+h))}return{price_without_tax:a,tax_value:r,price_with_tax:n}}computeCustomProductTax(e){e.$original();const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.custom_price_edit);return t.custom_price_without_tax=s.price_without_tax,t.custom_price_with_tax=s.price_with_tax,t.custom_price_tax=s.tax_value,e.$quantities=()=>t,e}computeNormalProductTax(e){e.$original();const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.sale_price_edit);return t.sale_price_without_tax=s.price_without_tax,t.sale_price_with_tax=s.price_with_tax,t.sale_price_tax=s.tax_value,e.$quantities=()=>t,e}computeWholesaleProductTax(e){e.$original();const t=e.$quantities(),s=this.proceedProductTaxComputation(e,t.wholesale_price_edit);return t.wholesale_price_without_tax=s.price_without_tax,t.wholesale_price_with_tax=s.price_with_tax,t.wholesale_price_tax=s.tax_value,e.$quantities=()=>t,e}getPrice(e,t,s){switch(t){case"normal":return e["sale_price_"+s];case"wholesale":return e["wholesale_price_"+s];case"custom":return e["custom_price_"+s]}}computeProduct(e){e.product_type==="product"&&(e.mode==="normal"?(e.unit_price=this.getSalePrice(e.$quantities(),e.$original()),e.tax_value=e.$quantities().sale_price_tax*e.quantity):e.mode==="wholesale"&&(e.unit_price=this.getWholesalePrice(e.$quantities(),e.$original()),e.tax_value=e.$quantities().wholesale_price_tax*e.quantity),e.mode==="custom"&&(e.unit_price=this.getCustomPrice(e.$quantities(),e.$original()),e.tax_value=e.$quantities().custom_price_tax*e.quantity));let t=0,s=0,i=this.getPrice(e.$quantities(),e.mode,"with_tax"),a=this.getPrice(e.$quantities(),e.mode,"without_tax");["flat","percentage"].includes(e.discount_type)&&(e.discount_type==="percentage"?(e.discount=e.unit_price*e.discount_percentage/100*e.quantity,t=a*e.discount_percentage/100*e.quantity,s=i*e.discount_percentage/100*e.quantity):(t=e.discount,s=e.discount)),e.price_with_tax=i,e.price_without_tax=a,e.total_price=e.unit_price*e.quantity-e.discount,e.total_price_with_tax=i*e.quantity-s,e.total_price_without_tax=a*e.quantity-t,g.doAction("ns-after-product-computed",e)}loadCustomer(e){return y.get(`/api/customers/${e}`)}defineSettings(e){this._settings.next(e)}voidOrder(e){e.id!==void 0?["hold"].includes(e.payment_status)?T.show(S,{title:c("Order Deletion"),message:c("The current order will be deleted as no payment has been made so far."),onAction:t=>{t&&y.delete(`/api/orders/${e.id}`).subscribe({next:s=>{p.success(s.message).subscribe(),this.reset()},error:s=>p.error(s.message).subscribe()})}}):T.show(we,{title:c("Void The Order"),message:c("The current order will be void. This will cancel the transaction, but the order won't be deleted. Further details about the operation will be tracked on the report. Consider providing the reason of this operation."),onAction:t=>{t!==!1&&y.post(`/api/orders/${e.id}/void`,{reason:t}).subscribe({next:s=>{p.success(s.message).subscribe(),this.reset()},error:s=>p.error(s.message).subscribe()})}}):p.error(c("Unable to void an unpaid order.")).subscribe()}async triggerOrderTypeSelection(e){for(let t=0;t<this.orderTypeQueue.length;t++)await this.orderTypeQueue[t].promise(e)}set(e,t){const s=this.settings.getValue();s[e]=t,this.settings.next(s)}unset(e){const t=this.settings.getValue();delete t[e],this.settings.next(t)}get(e){return this.settings.getValue()[e]}destroy(){this._products.unsubscribe(),this._customers.unsubscribe(),this._types.unsubscribe(),this._breadcrumbs.unsubscribe(),this._paymentsType.unsubscribe(),this._screen.unsubscribe(),this._order.unsubscribe(),this._settings.unsubscribe()}};window.POS=new E;window.POSClass=E;
