import{_ as c,p as h,j as w,o as r,a as u,f as t,t as l,q as P,F as p,r as f,e as m,n as V,m as x,bH as q,P as b,k as v,x as C,bz as S,w as T,l as j,i as U}from"./bootstrap.b3920df9.js";import{_ as g}from"./plugin-vue_export-helper.21dcd24c.js";import k from"./ns-pos-confirm-popup.1b443749.js";import $ from"./ns-prompt-popup.9575a5e5.js";import"./currency.ddae5e8e.js";const A={data(){return{finalValue:1,virtualStock:null,allSelected:!0,isLoading:!1,keys:[...[1,2,3].map(e=>({identifier:e,value:e})),...[4,5,6].map(e=>({identifier:e,value:e})),...[7,8,9].map(e=>({identifier:e,value:e})),{identifier:"backspace",icon:"la-backspace"},{identifier:0,value:0},{identifier:"next",icon:"la-share"}]}},mounted(){this.$popup.event.subscribe(e=>{e.event==="click-overlay"&&this.closePopup()}),this.$popupParams.quantity&&(this.finalValue=this.$popupParams.quantity),document.addEventListener("keyup",this.handleKeyPress)},destroyed(){document.removeEventListener("keypress",this.handleKeyPress)},methods:{__:c,handleKeyPress(e){e.keyCode===13&&this.inputValue({identifier:"next"})},closePopup(){this.$popupParams.reject(!1),this.$popup.close()},inputValue(e){if(e.identifier==="next"){this.$popupParams;const n=parseFloat(this.finalValue);if(n===0)return h.error(c("Please provide a quantity")).subscribe();this.resolve({quantity:n})}else e.identifier==="backspace"?this.allSelected?(this.finalValue=0,this.allSelected=!1):(this.finalValue=this.finalValue.toString(),this.finalValue=this.finalValue.substr(0,this.finalValue.length-1)||0):this.allSelected?(this.finalValue=e.value,this.finalValue=parseFloat(this.finalValue),this.allSelected=!1):(this.finalValue+=""+e.value,this.finalValue=parseFloat(this.finalValue))},resolve(e){this.$popupParams.resolve(e),this.$popup.close()}}},L={class:"ns-box shadow min-h-2/5-screen w-3/4-screen md:w-3/5-screen lg:w-3/5-screen xl:w-2/5-screen relative"},F={class:"flex-shrink-0 flex p-2 border-b ns-box-header justify-between items-center"},K={class:"text-xl font-bold text-primary text-center"},Q={id:"screen",class:"h-16 border-b ns-box-body flex items-center justify-center"},z={class:"font-bold text-3xl"},B={id:"numpad",class:"grid grid-flow-row grid-cols-3 grid-rows-3"},D=["onClick"],N={key:0};function E(e,n,i,_,d,o){const y=w("ns-close-button");return r(),u("div",L,[t("div",F,[t("h1",K,l(o.__("Define Quantity")),1),t("div",null,[P(y,{onClick:n[0]||(n[0]=s=>o.closePopup())})])]),t("div",Q,[t("h1",z,l(d.finalValue),1)]),t("div",B,[(r(!0),u(p,null,f(d.keys,(s,a)=>(r(),u("div",{onClick:ze=>o.inputValue(s),key:a,class:"text-xl font-bold border ns-numpad-key h-24 flex items-center justify-center cursor-pointer"},[s.value!==void 0?(r(),u("span",N,l(s.value),1)):m("",!0),s.icon?(r(),u("i",{key:1,class:V(["las",s.icon])},null,2)):m("",!0)],8,D))),128))])])}var M=g(A,[["render",E]]);const O={name:"ns-stock-adjustment",props:["actions"],data(){return{search:"",timeout:null,suggestions:[],products:[]}},mounted(){console.log(this.actions)},methods:{__:c,searchProduct(e){e.length>0&&x.post("/api/nexopos/v4/procurements/products/search-procurement-product",{argument:e}).subscribe(n=>{if(n.from==="products")if(n.products.length>0)n.products.length===1?this.addSuggestion(n.products[0]):this.suggestions=n.products;else return this.closeSearch(),h.error(c("Looks like no products matched the searched term.")).subscribe();else if(n.from==="procurements"){if(n.product===null)return this.closeSearch(),h.error(c("Looks like no products matched the searched term.")).subscribe();this.addProductToList(n.product)}})},addProductToList(e){if(this.products.filter(_=>_.procurement_product_id===e.id).length>0)return this.closeSearch(),h.error(c("The product already exists on the table.")).subscribe();const i=new Object;e.unit_quantity.unit=e.unit,i.quantities=[e.unit_quantity],i.name=e.name,i.adjust_unit=e.unit_quantity,i.adjust_quantity=1,i.adjust_action="",i.adjust_reason="",i.adjust_value=0,i.id=e.product_id,i.accurate_tracking=1,i.available_quantity=e.available_quantity,i.procurement_product_id=e.id,i.procurement_history=[{label:`${e.procurement.name} (${e.available_quantity})`,value:e.id}],this.products.push(i),this.closeSearch()},addSuggestion(e){q([x.get(`/api/nexopos/v4/products/${e.id}/units/quantities`)]).subscribe(n=>{if(n[0].length>0)e.quantities=n[0],e.adjust_quantity=1,e.adjust_action="",e.adjust_reason="",e.adjust_unit="",e.adjust_value=0,e.procurement_product_id=0,this.products.push(e),this.closeSearch();else return h.error(c("This product does't have any stock to adjust.")).subscribe();e.accurate_tracking})},closeSearch(){this.search="",this.suggestions=[]},recalculateProduct(e){e.adjust_unit!==""&&(["deleted","defective","lost"].includes(e.adjust_action)?e.adjust_value=-(e.adjust_quantity*e.adjust_unit.sale_price):e.adjust_value=e.adjust_quantity*e.adjust_unit.sale_price),this.$forceUpdate()},openQuantityPopup(e){e.quantity,new Promise((i,_)=>{b.show(M,{resolve:i,reject:_,quantity:e.adjust_quantity})}).then(i=>{if(!["added"].includes(e.adjust_action)){if(e.accurate_tracking!==void 0&&i.quantity>e.available_quantity)return h.error(c("The specified quantity exceed the available quantity.")).subscribe();if(i.quantity>e.adjust_unit.quantity)return h.error(c("The specified quantity exceed the available quantity.")).subscribe()}e.adjust_quantity=i.quantity,this.recalculateProduct(e)})},proceedStockAdjustment(){if(this.products.length===0)return h.error(c("Unable to proceed as the table is empty.")).subscribe();b.show(k,{title:c("Confirm Your Action"),message:c("The stock adjustment is about to be made. Would you like to confirm ?"),onAction:e=>{e&&x.post("/api/nexopos/v4/products/adjustments",{products:this.products}).subscribe(n=>{h.success(n.message).subscribe(),this.products=[]},n=>{h.error(n.message).subscribe()})}})},provideReason(e){new Promise((i,_)=>{b.show($,{title:c("More Details"),resolve:i,reject:_,message:c("Useful to describe better what are the reasons that leaded to this adjustment."),input:e.adjust_reason,onAction:d=>{d!==!1&&(e.adjust_reason=d)}})}).then(i=>{h.success(c("The reason has been updated.")).susbcribe()}).catch(i=>{})},removeProduct(e){b.show(k,{title:c("Confirm Your Action"),message:c("Would you like to remove this product from the table ?"),onAction:n=>{if(n){const i=this.products.indexOf(e);this.products.splice(i,1)}}})}},watch:{search(){this.search.length>0?(clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.searchProduct(this.search)},500)):this.closeSearch()}}},H={class:"input-field flex border-2 input-group rounded"},R={class:"px-3 py-2 rounded-none"},W={key:0,class:"h-0"},Y={class:""},J={class:"shadow h-96 relative z-10 ns-vertical-menu zoom-in-entrance anim-duration-300 overflow-y-auto"},G=["onClick"],I={class:"ns-box rounded shadow my-2 w-full"},X={class:"table w-full ns-table"},Z={class:"border-b"},ee={class:"p-2"},te={width:"120",class:"p-2 text-center"},se={width:"120",class:"p-2 text-center"},ne={width:"120",class:"p-2 text-center"},ie={width:"120",class:"p-2 text-center"},ae={width:"120",class:"p-2 text-center"},oe={width:"150",class:"p-2 text-center"},le={key:0},re={class:"p-2 text-center",colspan:"6"},ue={class:"p-2"},ce={class:"p-2"},de={class:"input-group border-2 info"},he=["onChange","onUpdate:modelValue"],_e=["value"],pe={class:"p-2"},fe={class:"input-group border-2 info"},me=["onChange","onUpdate:modelValue"],be=["value"],ve={class:"p-2"},ye={key:0,class:"input-group border-2 info"},xe=["onChange","onUpdate:modelValue"],je=["value"],ke=["onClick"],we={class:"border-b border-dashed border-blue-400 py-2 px-4"},Pe={class:"p-2"},ge={class:"border-b border-dashed border-blue-400 py-2 px-4"},Ve={class:"p-2"},qe={class:"-mx-1 flex justify-end"},Ce={class:"px-1"},Se=["onClick"],Te=t("i",{class:"las la-comment-dots"},null,-1),Ue=[Te],$e={class:"px-1"},Ae=["onClick"],Le=t("i",{class:"las la-times"},null,-1),Fe=[Le],Ke={class:"border-t ns-box-footer p-2 flex justify-end"};function Qe(e,n,i,_,d,o){const y=w("ns-button");return r(),u("div",null,[t("div",H,[v(t("input",{onKeyup:n[0]||(n[0]=S(s=>o.closeSearch(),["esc"])),"onUpdate:modelValue":n[1]||(n[1]=s=>d.search=s),type:"text",class:"p-2 flex-auto outline-none"},null,544),[[C,d.search]]),t("button",R,l(o.__("Search")),1)]),d.suggestions.length>0?(r(),u("div",W,[t("div",Y,[t("ul",J,[(r(!0),u(p,null,f(d.suggestions,s=>(r(),u("li",{onClick:a=>o.addSuggestion(s),key:s.id,class:"cursor-pointer border-b p-2 flex justify-between"},[t("span",null,l(s.name),1)],8,G))),128))])])])):m("",!0),t("div",I,[t("table",X,[t("thead",Z,[t("tr",null,[t("td",ee,l(o.__("Product")),1),t("td",te,l(o.__("Unit")),1),t("td",se,l(o.__("Operation")),1),t("td",ne,l(o.__("Procurement")),1),t("td",ie,l(o.__("Quantity")),1),t("td",ae,l(o.__("Value")),1),t("td",oe,l(o.__("Actions")),1)])]),t("tbody",null,[d.products.length===0?(r(),u("tr",le,[t("td",re,l(o.__("Search and add some products")),1)])):m("",!0),(r(!0),u(p,null,f(d.products,s=>(r(),u("tr",{key:s.id},[t("td",ue,l(s.name)+" ("+l((s.accurate_tracking===1?s.available_quantity:s.adjust_unit.quantity)||0)+")",1),t("td",ce,[t("div",de,[v(t("select",{onChange:a=>o.recalculateProduct(s),"onUpdate:modelValue":a=>s.adjust_unit=a,class:"outline-none p-2 w-full"},[(r(!0),u(p,null,f(s.quantities,a=>(r(),u("option",{key:a.id,value:a},l(a.unit.name),9,_e))),128))],40,he),[[j,s.adjust_unit]])])]),t("td",pe,[t("div",fe,[v(t("select",{onChange:a=>o.recalculateProduct(s),"onUpdate:modelValue":a=>s.adjust_action=a,name:"",id:"",class:"outline-none p-2 w-full"},[(r(!0),u(p,null,f(i.actions,a=>(r(),u("option",{key:a.value,value:a.value},l(a.label),9,be))),128))],40,me),[[j,s.adjust_action]])])]),t("td",ve,[s.accurate_tracking===1?(r(),u("div",ye,[v(t("select",{onChange:a=>o.recalculateProduct(s),"onUpdate:modelValue":a=>s.procurement_product_id=a,name:"",id:"",class:"outline-none p-2 bg-white w-full"},[(r(!0),u(p,null,f(s.procurement_history,a=>(r(),u("option",{key:a.value,value:a.value},l(a.label),9,je))),128))],40,xe),[[j,s.procurement_product_id]])])):m("",!0)]),t("td",{class:"p-2 flex items-center justify-center cursor-pointer",onClick:a=>o.openQuantityPopup(s)},[t("span",we,l(s.adjust_quantity),1)],8,ke),t("td",Pe,[t("span",ge,l(e.nsCurrency(s.adjust_value)),1)]),t("td",Ve,[t("div",qe,[t("div",Ce,[t("button",{onClick:a=>o.provideReason(s),class:"ns-inset-button active info border outline-none rounded-full shadow h-10 w-10"},Ue,8,Se)]),t("div",$e,[t("button",{onClick:a=>o.removeProduct(s),class:"ns-inset-button active error border outline-none rounded-full shadow h-10 w-10"},Fe,8,Ae)])])])]))),128))])]),t("div",Ke,[P(y,{onClick:n[2]||(n[2]=s=>o.proceedStockAdjustment()),type:"info"},{default:T(()=>[U(l(o.__("Proceed")),1)]),_:1})])])])}var Oe=g(O,[["render",Qe]]);export{Oe as default};
