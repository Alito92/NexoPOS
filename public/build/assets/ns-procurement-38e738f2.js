import{F as P,a as x,n as y,T as L}from"./bootstrap-9d0e4bdd.js";import S from"./manage-products-9edac79a.js";import{_ as p,n as E}from"./currency-d0508508.js";import{_ as O}from"./_plugin-vue_export-helper-c27b6911.js";import{ae as F,a6 as a,z as n,A as r,F as m,ac as v,x as j,c as q,ax as B,H as T,y as _,az as g,ad as U}from"./npm~@vue~runtime-core_-c1400cf1.js";import{U as u,z as k}from"./npm~@vue~shared_-82b01912.js";import{m as V,l as C}from"./npm~@vue~runtime-dom_-3cadedeb.js";import{f as N}from"./npm~rxjs-a7e91008.js";import"./npm~lodash-f5508214.js";import"./npm~@ckeditor~ckeditor5-build-classic_-5cff4652.js";import"./npm~laravel-echo-8b7e2b1d.js";import"./npm~pusher-js-244b366d.js";import"./npm~axios-4a70c6fc.js";import"./npm~chart.js-3fed1729.js";import"./npm~moment-fbc5633a.js";import"./npm~vue-d815d99e.js";import"./npm~@vue~compiler-dom_-04241bb4.js";import"./npm~@vue~compiler-core_-2a2ce8c7.js";import"./npm~@vue~reactivity_-46d78a21.js";import"./npm~rx-812d4a49.js";import"./npm~@wordpress~hooks_-18172e20.js";import"./npm~mathjs-eae2cf2e.js";import"./npm~@babel~runtime_-57eb5ba4.js";import"./npm~decimal.js-d133ee8e.js";import"./npm~complex.js-3f247aa1.js";import"./npm~fraction.js-324b3911.js";import"./npm~typed-function-4896e4f1.js";import"./npm~seedrandom-852a687d.js";import"./npm~javascript-natural-sort-2161c071.js";import"./npm~escape-latex-137e2782.js";import"./ns-pos-confirm-popup-ade80be0.js";import"./ns-paginate-95683a82.js";import"./npm~numeral-b19ffe25.js";import"./npm~currency.js-57f74176.js";import"./npm~tslib-f3101d7c.js";const D={name:"ns-procurement-product-options",props:["popup"],data(){return{validation:new P,fields:[],rawFields:[{label:p("Expiration Date"),name:"expiration_date",description:p("Define when that specific product should expire."),type:"datetimepicker"},{label:p("Barcode"),name:"barcode",description:p("Renders the automatically generated barcode."),type:"text",disabled:!0},{label:p("Tax Type"),name:"tax_type",description:p("Adjust how tax is calculated on the item."),type:"select",options:[{label:p("Inclusive"),value:"inclusive"},{label:p("Exclusive"),value:"exclusive"}]}]}},methods:{__:p,applyChanges(){if(this.validation.validateFields(this.fields)){const e=this.validation.extractFields(this.fields);return this.popup.params.resolve(e),this.popup.close()}return x.error(p("Unable to proceed. The form is not valid.")).subscribe()}},mounted(){const t=this.rawFields.map(e=>(e.name==="expiration_date"&&(e.value=this.popup.params.product.procurement.expiration_date),e.name==="tax_type"&&(e.value=this.popup.params.product.procurement.tax_type),e.name==="barcode"&&(e.value=this.popup.params.product.procurement.barcode),e));this.fields=this.validation.createFields(t)}},K={class:"ns-box shadow-lg w-6/7-screen md:w-5/7-screen lg:w-3/7-screen"},R={class:"p-2 border-b ns-box-header"},z={class:"font-semibold"},A={class:"p-2 border-b ns-box-body"},M={class:"p-2 flex justify-end ns-box-body"};function G(t,e,i,h,s,l){const w=F("ns-field"),o=F("ns-button");return a(),n("div",K,[r("div",R,[r("h5",z,u(l.__("Options")),1)]),r("div",A,[(a(!0),n(m,null,v(s.fields,(d,f)=>(a(),j(w,{class:"w-full",field:d,key:f},null,8,["field"]))),128))]),r("div",M,[q(o,{onClick:e[0]||(e[0]=d=>l.applyChanges()),type:"info"},{default:B(()=>[T(u(l.__("Save")),1)]),_:1})])])}const J=O(D,[["render",G]]),H={name:"ns-procurement",mounted(){this.reloadEntities()},computed:{activeTab(){return this.validTabs.filter(t=>t.active).length>0?this.validTabs.filter(t=>t.active)[0]:!1}},data(){return{totalTaxValues:0,totalPurchasePrice:0,formValidation:new P,form:{},nsSnackBar:x,fields:[],searchResult:[],searchValue:"",debounceSearch:null,nsHttpClient:y,taxes:[],validTabs:[{label:p("Details"),identifier:"details",active:!0},{label:p("Products"),identifier:"products",active:!1}],reloading:!1}},watch:{searchValue(t){t&&(clearTimeout(this.debounceSearch),this.debounceSearch=setTimeout(()=>{this.doSearch(t)},500))}},components:{nsManageProducts:S},props:["submit-method","submit-url","return-url","src","rules"],methods:{__:p,nsCurrency:E,computeTotal(){this.totalTaxValues=0,this.form.products.length>0&&(this.totalTaxValues=this.form.products.map(t=>t.procurement.tax_value).reduce((t,e)=>t+e)),this.totalPurchasePrice=0,this.form.products.length>0&&(this.totalPurchasePrice=this.form.products.map(t=>parseFloat(t.procurement.total_purchase_price)).reduce((t,e)=>t+e))},updateLine(t){const e=this.form.products[t],i=this.taxes.filter(h=>h.id===e.procurement.tax_group_id);if(parseFloat(e.procurement.purchase_price_edit)>0&&parseFloat(e.procurement.quantity)>0){if(i.length>0){const h=i[0].taxes.map(s=>L.getTaxValue(e.procurement.tax_type,e.procurement.purchase_price_edit,parseFloat(s.rate)));e.procurement.tax_value=h.reduce((s,l)=>s+l),e.procurement.tax_type==="inclusive"?(e.procurement.net_purchase_price=parseFloat(e.procurement.purchase_price_edit)-e.procurement.tax_value,e.procurement.gross_purchase_price=parseFloat(e.procurement.purchase_price_edit),e.procurement.purchase_price=parseFloat(e.procurement.gross_purchase_price)):(e.procurement.gross_purchase_price=parseFloat(e.procurement.purchase_price_edit)+e.procurement.tax_value,e.procurement.net_purchase_price=parseFloat(e.procurement.purchase_price_edit),e.procurement.purchase_price=parseFloat(e.procurement.gross_purchase_price))}else e.procurement.gross_purchase_price=parseFloat(e.procurement.purchase_price_edit),e.procurement.purchase_price=parseFloat(e.procurement.purchase_price_edit),e.procurement.net_purchase_price=parseFloat(e.procurement.purchase_price_edit),e.procurement.tax_value=0;e.procurement.tax_value=e.procurement.tax_value*parseFloat(e.procurement.quantity),e.procurement.total_purchase_price=e.procurement.purchase_price*parseFloat(e.procurement.quantity)}this.computeTotal(),this.$forceUpdate()},fetchLastPurchasePrice(t){const e=this.form.products[t],i=e.unit_quantities.filter(h=>e.procurement.unit_id===h.unit_id);i.length>0&&(e.procurement.purchase_price_edit=i[0].last_purchase_price||0),this.updateLine(t)},switchTaxType(t,e){t.procurement.tax_type=t.procurement.tax_type==="inclusive"?"exclusive":"inclusive",this.updateLine(e)},doSearch(t){y.post("/api/procurements/products/search-product",{search:t}).subscribe(e=>{e.length===1?this.addProductList(e[0]):e.length>1?this.searchResult=e:x.error(p("No result match your query.")).subscribe()})},reloadEntities(){this.reloading=!0,N([y.get("/api/categories"),y.get("/api/products"),y.get(this.src),y.get("/api/taxes/groups")]).subscribe(t=>{this.reloading=!1,this.categories=t[0],this.products=t[1],this.taxes=t[3],this.form.general&&t[2].tabs.general.fieds.forEach((e,i)=>{e.value=this.form.tabs.general.fields[i].value||""}),this.form=Object.assign(JSON.parse(JSON.stringify(t[2])),this.form),this.form=this.formValidation.createForm(this.form),this.form.tabs&&this.form.tabs.general.fields.forEach((e,i)=>{e.options&&(e.options=t[2].tabs.general.fields[i].options)}),this.form.products.length===0&&(this.form.products=this.form.products.map(e=>(["gross_purchase_price","purchase_price_edit","tax_value","net_purchase_price","purchase_price","total_price","total_purchase_price","quantity","tax_group_id"].forEach(i=>{e[i]===void 0&&(e[i]=e[i]===void 0?0:e[i])}),e.$invalid=e.$invalid||!1,e.purchase_price_edit=e.purchase_price,{name:e.name,purchase_units:e.purchase_units,procurement:e,unit_quantities:e.unit_quantities||[]}))),this.$forceUpdate()})},setTabActive(t){this.validTabs.forEach(e=>e.active=!1),this.$forceUpdate(),this.$nextTick().then(()=>{t.active=!0})},addProductList(t){if(t.unit_quantities===void 0)return x.error(p("Unable to add product which doesn't unit quantities defined.")).subscribe();t.procurement=new Object,t.procurement.gross_purchase_price=0,t.procurement.purchase_price_edit=0,t.procurement.tax_value=0,t.procurement.net_purchase_price=0,t.procurement.purchase_price=0,t.procurement.total_price=0,t.procurement.total_purchase_price=0,t.procurement.quantity=1,t.procurement.expiration_date=null,t.procurement.tax_group_id=0,t.procurement.tax_type="inclusive",t.procurement.unit_id=0,t.procurement.product_id=t.id,t.procurement.procurement_id=null,t.procurement.$invalid=!1,this.searchResult=[],this.searchValue="",this.form.products.push(t)},submit(){if(this.form.products.length===0)return x.error(p("Unable to proceed, no product were provided."),p("OK")).subscribe();if(this.form.products.forEach(i=>{!parseFloat(i.procurement.quantity)>=1||i.procurement.unit_id===0?i.procurement.$invalid=!0:i.procurement.$invalid=!1}),this.form.products.filter(i=>i.procurement.$invalid).length>0)return x.error(p("Unable to proceed, one or more product has incorrect values."),p("OK")).subscribe();if(this.formValidation.validateForm(this.form).length>0)return this.setTabActive(this.activeTab),x.error(p("Unable to proceed, the procurement form is not valid."),p("OK")).subscribe();if(this.submitUrl===void 0)return x.error(p("Unable to submit, no valid submit URL were provided."),p("OK")).subscribe();this.formValidation.disableForm(this.form);const e={...this.formValidation.extractForm(this.form),products:this.form.products.map(i=>i.procurement)};y[this.submitMethod?this.submitMethod.toLowerCase():"post"](this.submitUrl,e).subscribe(i=>{if(i.status==="success")return document.location=this.returnUrl;this.formValidation.enableForm(this.form)},i=>{x.error(i.message,void 0,{duration:5e3}).subscribe(),this.formValidation.enableForm(this.form),i.errors&&this.formValidation.triggerError(this.form,i.errors)})},deleteProduct(t){this.form.products.splice(t,1),this.$forceUpdate()},handleGlobalChange(t){this.globallyChecked=t,this.rows.forEach(e=>e.$checked=t)},setProductOptions(t){new Promise((i,h)=>{Popup.show(J,{product:this.form.products[t],resolve:i,reject:h})}).then(i=>{for(let h in i)this.form.products[t].procurement[h]=i[h];this.updateLine(t)})}}},I={class:"form flex-auto flex flex-col",id:"crud-form"},Q={class:"flex flex-col"},W={class:"flex justify-between items-center"},X={for:"title",class:"font-bold my-2 text-primary"},Y={for:"title",class:"text-sm my-2 text-primary"},Z=["href"],$=["disabled"],ee=["disabled"],te={key:0,class:"text-xs text-primary py-1"},re={id:"form-container",class:"-mx-4 flex flex-wrap mt-4"},se={class:"px-4 w-full"},ie={id:"tabbed-card",class:"ns-tab"},oe={id:"card-header",class:"flex flex-wrap"},ae=["onClick"],ne={key:0,class:"ns-tab-item"},le={class:"card-body rounded-br-lg rounded-bl-lg shadow p-2"},ce={key:0,class:"-mx-4 flex flex-wrap"},ue={key:1,class:"ns-tab-item"},pe={class:"card-body rounded-br-lg rounded-bl-lg shadow p-2"},de={class:"mb-2"},me={class:"input-group info flex border-2 rounded overflow-hidden"},he=["placeholder"],_e={class:"h-0"},fe={class:"shadow bg-floating-menu relative z-10"},be=["onClick"],ve={class:"block font-bold text-primary"},xe={class:"block text-sm text-priamry"},ye={class:"block text-sm text-primary"},ge={class:"overflow-x-auto"},ke={class:"w-full ns-table"},we={class:"flex items-start"},Ve={class:"input-group rounded border-2"},Ce=["onChange","onUpdate:modelValue"],Fe=["value"],Te={class:"font-semibold"},Ue={class:"flex justify-between"},Pe={class:"flex -mx-1 flex-col"},Oe={class:"px-1"},qe=["onClick"],Le={class:"flex -mx-1 flex-col"},Se={class:"px-1"},Ee=["onClick"],je={class:"flex items-start"},Be={class:"input-group rounded border-2"},Ne=["onChange","onUpdate:modelValue"],De={class:"flex items-start"},Ke={class:"input-group rounded border-2"},Re=["onChange","onUpdate:modelValue"],ze=["value"],Ae={class:"flex items-start flex-col justify-end"},Me={class:"text-sm text-primary"},Ge={class:"flex items-start"},Je={class:"input-group rounded border-2"},He=["onChange","onUpdate:modelValue"],Ie=["value"],Qe={class:"text-primary"},We=["colspan"],Xe={class:"p-2 border"},Ye=["colspan"],Ze={class:"p-2 border"};function $e(t,e,i,h,s,l){const w=F("ns-field");return a(),n("div",I,[s.form.main?(a(),n(m,{key:0},[r("div",Q,[r("div",W,[r("label",X,u(s.form.main.label||l.__("No title is provided")),1),r("div",Y,[t.returnUrl?(a(),n("a",{key:0,href:t.returnUrl,class:"rounded-full ns-inset-button border px-2 py-1"},u(l.__("Go Back")),9,Z)):_("",!0)])]),r("div",{class:k([s.form.main.disabled?"disabled":s.form.main.errors.length>0?"error":"","flex border-2 rounded input-group info overflow-hidden"])},[g(r("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>s.form.main.value=o),onBlur:e[1]||(e[1]=o=>s.formValidation.checkField(s.form.main)),onChange:e[2]||(e[2]=o=>s.formValidation.checkField(s.form.main)),disabled:s.form.main.disabled,type:"text",class:k([(s.form.main.disabled,""),"flex-auto outline-none h-10 px-2"])},null,42,$),[[V,s.form.main.value]]),r("button",{disabled:s.form.main.disabled,onClick:e[3]||(e[3]=o=>l.submit()),class:"outline-none px-4 h-10 border-l"},[U(t.$slots,"save",{},()=>[T(u(l.__("Save")),1)])],8,ee),r("button",{onClick:e[4]||(e[4]=o=>l.reloadEntities()),class:"outline-none px-4 h-10"},[r("i",{class:k([s.reloading?"animate animate-spin":"","las la-sync"])},null,2)])],2),s.form.main.description&&s.form.main.errors.length===0?(a(),n("p",te,u(s.form.main.description),1)):_("",!0),(a(!0),n(m,null,v(s.form.main.errors,(o,d)=>(a(),n("p",{class:"text-xs py-1 text-error-primary",key:d},[r("span",null,[U(t.$slots,"error-required",{},()=>[T(u(o.identifier),1)])])]))),128))]),r("div",re,[r("div",se,[r("div",ie,[r("div",oe,[(a(!0),n(m,null,v(s.validTabs,(o,d)=>(a(),n("div",{onClick:f=>l.setTabActive(o),class:k([o.active?"active":"inactive","tab cursor-pointer px-4 py-2 rounded-tl-lg rounded-tr-lg text-primary"]),key:d},u(o.label),11,ae))),128))]),l.activeTab.identifier==="details"?(a(),n("div",ne,[r("div",le,[s.form.tabs?(a(),n("div",ce,[(a(!0),n(m,null,v(s.form.tabs.general.fields,(o,d)=>(a(),n("div",{class:"flex px-4 w-full md:w-1/2 lg:w-1/3",key:d},[q(w,{field:o},null,8,["field"])]))),128))])):_("",!0)])])):_("",!0),l.activeTab.identifier==="products"?(a(),n("div",ue,[r("div",pe,[r("div",de,[r("div",me,[g(r("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>s.searchValue=o),type:"text",placeholder:l.__("SKU, Barcode, Name"),class:"flex-auto text-primary outline-none h-10 px-2"},null,8,he),[[V,s.searchValue]])]),r("div",_e,[r("div",fe,[(a(!0),n(m,null,v(s.searchResult,(o,d)=>(a(),n("div",{onClick:f=>l.addProductList(o),key:d,class:"cursor-pointer border border-b hover:bg-floating-menu-hover border-floating-menu-edge p-2 text-primary"},[r("span",ve,u(o.name),1),r("span",xe,u(l.__("SKU"))+" : "+u(o.sku),1),r("span",ye,u(l.__("Barcode"))+" : "+u(o.barcode),1)],8,be))),128))])])]),r("div",ge,[r("table",ke,[r("thead",null,[r("tr",null,[(a(!0),n(m,null,v(s.form.columns,(o,d)=>(a(),n("td",{width:"200",key:d,class:"text-primary p-2 border"},u(o.label),1))),128))])]),r("tbody",null,[(a(!0),n(m,null,v(s.form.products,(o,d)=>(a(),n("tr",{key:d,class:k(o.procurement.$invalid?"error border-2 border-error-primary":"")},[(a(!0),n(m,null,v(s.form.columns,(f,b)=>(a(),n(m,null,[f.type==="tax_group_id"?(a(),n("td",{key:b,class:"p-2 text-primary border"},[r("div",we,[r("div",Ve,[g(r("select",{onChange:c=>l.updateLine(d),"onUpdate:modelValue":c=>o.procurement.tax_group_id=c,class:"p-2"},[(a(!0),n(m,null,v(s.taxes,c=>(a(),n("option",{key:c.id,value:c.id},u(c.name),9,Fe))),128))],40,Ce),[[C,o.procurement.tax_group_id]])])])])):_("",!0),f.type==="name"?(a(),n("td",{key:b,class:"p-2 text-primary border"},[r("span",Te,u(o.name),1),r("div",Ue,[r("div",Pe,[r("div",Oe,[r("span",{class:"text-xs text-error-primary cursor-pointer underline px-1",onClick:c=>l.deleteProduct(d)},u(l.__("Delete")),9,qe)])]),r("div",Le,[r("div",Se,[r("span",{class:"text-xs text-error-primary cursor-pointer underline px-1",onClick:c=>l.setProductOptions(d)},u(l.__("Options")),9,Ee)])])])])):_("",!0),f.type==="text"?(a(),n("td",{key:b,class:"p-2 w-3 text-primary border"},[r("div",je,[r("div",Be,[g(r("input",{onChange:c=>l.updateLine(d),type:"text","onUpdate:modelValue":c=>o.procurement[b]=c,class:"w-24 p-2"},null,40,Ne),[[V,o.procurement[b]]])])])])):_("",!0),f.type==="custom_select"?(a(),n("td",{key:b,class:"p-2 text-primary border"},[r("div",De,[r("div",Ke,[g(r("select",{onChange:c=>l.updateLine(d),"onUpdate:modelValue":c=>o.procurement[b]=c,class:"p-2"},[(a(!0),n(m,null,v(f.options,c=>(a(),n("option",{key:c.value,value:c.value},u(c.label),9,ze))),128))],40,Re),[[C,o.procurement[b]]])])])])):_("",!0),f.type==="currency"?(a(),n("td",{key:b,class:"p-2 text-primary border"},[r("div",Ae,[r("span",Me,u(l.nsCurrency(o.procurement[b])),1)])])):_("",!0),f.type==="unit_quantities"?(a(),n("td",{key:b,class:"p-2 text-primary border"},[r("div",Ge,[r("div",Je,[g(r("select",{onChange:c=>l.fetchLastPurchasePrice(d),"onUpdate:modelValue":c=>o.procurement.unit_id=c,class:"p-2 w-32"},[(a(!0),n(m,null,v(o.unit_quantities,c=>(a(),n("option",{key:c.id,value:c.unit.id},u(c.unit.name),9,Ie))),128))],40,He),[[C,o.procurement.unit_id]])])])])):_("",!0)],64))),256))],2))),128)),r("tr",Qe,[r("td",{class:"p-2 border",colspan:Object.keys(s.form.columns).indexOf("tax_value")},null,8,We),r("td",Xe,u(l.nsCurrency(s.totalTaxValues)),1),r("td",{class:"p-2 border",colspan:Object.keys(s.form.columns).indexOf("total_purchase_price")-(Object.keys(s.form.columns).indexOf("tax_value")+1)},null,8,Ye),r("td",Ze,u(l.nsCurrency(s.totalPurchasePrice)),1)])])])])])])):_("",!0)])])])],64)):_("",!0)])}const jt=O(H,[["render",$e]]);export{jt as default};
